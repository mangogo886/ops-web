<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{.Title}} - æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</title>
    <style>
    body { 
        margin: 0; 
        padding: 0; 
        font-family: "Microsoft YaHei", sans-serif; 
        display: flex; 
        height: 100vh; 
    }
    
    /* å·¦ä¾§å¯¼èˆª */
    .sidebar { 
        width: 180px; 
        background-color: #2c3e50; 
        color: white; 
        display: flex; 
        flex-direction: column; 
    }
    .sidebar h3 { 
        text-align: center; 
        padding: 20px 0; 
        border-bottom: 1px solid #34495e; 
        margin: 0; 
    }
    .menu-item { 
        padding: 15px 20px; 
        color: #ecf0f1; 
        text-decoration: none; 
        display: block; 
        border-bottom: 1px solid #34495e; 
    }
    .menu-item:hover { 
        background-color: #34495e; 
    }
    .menu-item.active { 
        background-color: #3498db; 
    }
    .submenu-item {
        padding: 12px 20px 12px 40px;
        font-size: 14px;
        color: #bdc3c7;
        text-decoration: none;
        display: block;
        border-bottom: 1px solid #34495e;
    }
    .submenu-item:hover {
        background-color: #34495e;
    }
    .submenu-item.active {
        background-color: #2980b9;
        color: white;
    }
    
    .content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    /* è¡¨å•æ ·å¼ */
    .edit-form {
        background: white;
        padding: 30px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        max-width: 800px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    .form-group input[type="text"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
    }
    .form-group textarea {
        min-height: 120px;
        resize: vertical;
    }
    .form-group select {
        width: 300px;
    }
    .back-btn {
        display: inline-block;
        padding: 8px 15px;
        background-color: #95a5a6;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .back-btn:hover {
        background-color: #7f8c8d;
    }
    .btn-group {
        margin-top: 30px;
        display: flex;
        gap: 10px;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary {
        background-color: #3498db;
        color: white;
    }
    .btn-primary:hover {
        background-color: #2980b9;
    }
    .btn-secondary {
        background-color: #95a5a6;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #7f8c8d;
    }
    .task-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .task-info-row {
        margin-bottom: 8px;
        color: #555;
    }

    /* å®¡æ ¸æ„è§è®°å½•å¼¹çª— */
    .history-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .history-modal-content {
        position: absolute;
        background-color: #fefefe;
        border: 1px solid #888;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: 800px;
        height: 600px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        resize: both;
        overflow: hidden;
        min-width: 600px;
        min-height: 400px;
    }
    .history-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
        background-color: #2c3e50;
        color: white;
        cursor: move;
        flex-shrink: 0;
    }
    .history-modal-header h3 {
        margin: 0;
        color: white;
    }
    .history-modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    .history-modal-close:hover,
    .history-modal-close:focus {
        color: white;
    }
    .history-modal-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f5f6fa;
    }
    .history-item {
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        padding: 15px;
        border-left: 4px solid #3498db;
    }
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ecf0f1;
    }
    .history-item-time {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }
    .history-item-meta {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: #7f8c8d;
    }
    .history-item-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    .history-item-status.æœªå®¡æ ¸ {
        background-color: #ecf0f1;
        color: #34495e;
    }
    .history-item-status.å·²å®¡æ ¸å¾…æ•´æ”¹ {
        background-color: #f39c12;
        color: white;
    }
    .history-item-status.å·²å®Œæˆ {
        background-color: #27ae60;
        color: white;
    }
    .history-item-comment {
        color: #555;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-top: 10px;
    }
    .history-item-comment:empty::before {
        content: "ï¼ˆæ— å®¡æ ¸æ„è§ï¼‰";
        color: #95a5a6;
        font-style: italic;
    }
    .history-loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }
    .history-empty {
        text-align: center;
        padding: 60px 20px;
        color: #95a5a6;
        font-size: 16px;
    }
</style>
</head>
<body>
    <div class="sidebar">
        <h3>æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</h3>
        <a href="/stats" class="menu-item {{if eq .ActiveMenu "stats"}}active{{end}}">ç»Ÿè®¡ä¿¡æ¯</a>
        <a href="/device/filelist" class="menu-item {{if eq .ActiveMenu "filelist"}}active{{end}}">å»ºæ¡£æ˜ç»†</a>
        <a href="/device/filelist" class="submenu-item {{if eq .SubMenu "device_filelist"}}active{{end}}">è®¾å¤‡å»ºæ¡£æ˜ç»†</a>
        <a href="/checkpoint/filelist" class="submenu-item {{if eq .SubMenu "checkpoint_filelist"}}active{{end}}">å¡å£å»ºæ¡£æ˜ç»†</a>
        <a href="/audit" class="menu-item {{if eq .ActiveMenu "audit"}}active{{end}}">æ¡£æ¡ˆå®¡æ ¸</a>
        <a href="/audit/progress" class="submenu-item {{if eq .SubMenu "audit_progress"}}active{{end}}">è®¾å¤‡å®¡æ ¸è¿›åº¦</a>
        <a href="/audit/progress/video-reminders" class="submenu-item {{if eq .SubMenu "video_reminders"}}active{{end}}">å½•åƒå¤©æ•°ä¸è¶³æé†’</a>
        <a href="/checkpoint/progress" class="submenu-item {{if eq .SubMenu "checkpoint_progress"}}active{{end}}">å¡å£å®¡æ ¸è¿›åº¦</a>
        <a href="/audit/statistics" class="submenu-item {{if eq .SubMenu "audit_statistics"}}active{{end}}">æœˆåº¦å»ºæ¡£æ•°æ®</a>
        <a href="/users" class="menu-item {{if eq .ActiveMenu "settings"}}active{{end}}">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/users" class="submenu-item {{if eq .SubMenu "users"}}active{{end}}">ç”¨æˆ·ä¿¡æ¯</a>
        <a href="/permission" class="submenu-item {{if eq .SubMenu "permission"}}active{{end}}">æƒé™è®¾ç½®</a>
        <a href="/taskconfig" class="submenu-item {{if eq .SubMenu "task_config"}}active{{end}}">ä»»åŠ¡é…ç½®</a>
        <a href="/logs" class="submenu-item {{if eq .SubMenu "logs"}}active{{end}}">æ“ä½œæ—¥å¿—</a>
    </div>

    <div class="content">
        <a href="{{.BackURL}}" class="back-btn">â† è¿”å›è®¾å¤‡å®¡æ ¸è¿›åº¦</a>
        
        <h1>ç¼–è¾‘å®¡æ ¸æ„è§</h1>
        
        <!-- æ¡£æ¡ˆä¿¡æ¯ -->
        <div class="task-info">
            <div class="task-info-row"><strong>æ¡£æ¡ˆåç§°ï¼š</strong>{{.Task.FileName}}</div>
            <div class="task-info-row"><strong>æœºæ„åç§°ï¼š</strong>{{.Task.Organization}}</div>
            <div class="task-info-row"><strong>å¯¼å…¥æ—¶é—´ï¼š</strong>{{.Task.ImportTime}}</div>
            <div class="task-info-row" style="margin-top: 15px;">
                <a href="#" onclick="openAuditHistoryModal({{.Task.ID}}); return false;" class="back-btn" style="background-color: #16a085; margin-right: 10px;">å®¡æ ¸æ„è§è®°å½•</a>
            </div>
        </div>
        
        <!-- ç¼–è¾‘è¡¨å• -->
        <form class="edit-form" action="/audit/progress/edit" method="POST" id="editForm">
            <input type="hidden" name="task_id" value="{{.Task.ID}}">
            
            <div class="form-group">
                <label for="audit_status">å®¡æ ¸çŠ¶æ€ <span style="color: #e74c3c;">*</span></label>
                <select id="audit_status" name="audit_status" required>
                    <option value="æœªå®¡æ ¸" {{if eq .Task.AuditStatus "æœªå®¡æ ¸"}}selected{{end}}>æœªå®¡æ ¸</option>
                    <option value="å·²å®¡æ ¸å¾…æ•´æ”¹" {{if eq .Task.AuditStatus "å·²å®¡æ ¸å¾…æ•´æ”¹"}}selected{{end}}>å·²å®¡æ ¸å¾…æ•´æ”¹</option>
                    <option value="å·²å®Œæˆ" {{if eq .Task.AuditStatus "å·²å®Œæˆ"}}selected{{end}}>å·²å®Œæˆ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="audit_comment">å®¡æ ¸æ„è§</label>
                <textarea id="audit_comment" name="audit_comment" placeholder="è¯·è¾“å…¥å®¡æ ¸æ„è§...">{{if .Task.AuditComment.Valid}}{{.Task.AuditComment.String}}{{end}}</textarea>
                <div style="margin-top: 8px; padding: 10px; background-color: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; font-size: 13px; color: #555;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>å¦‚æœå®¡æ ¸æ„è§æ¶‰åŠå½•åƒå¤©æ•°ä¸è¶³ï¼Œè¯·æŒ‰ä»¥ä¸‹æ ¼å¼å¡«å†™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶åˆ›å»ºæé†’ä»»åŠ¡ï¼š<br>
                    <div style="margin-top: 8px; padding-left: 10px;">
                        â€¢ å½•åƒæœ€æ—©æ—¥æœŸï¼š2025-12-01ï¼Œä¸è¶³30å¤©<br>
                        â€¢ å½•åƒæœ€æ—©æ—¥æœŸï¼š2025-11-15ï¼Œä¸è¶³90å¤©<br>
                        â€¢ å½•åƒæœ€æ—©æ—¥æœŸï¼š2025-10-01ï¼Œä¸è¶³180å¤©<br>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">
                        æ”¯æŒçš„æ ¼å¼ï¼š<br>
                        - "å½•åƒæœ€æ—©æ—¥æœŸï¼šYYYY-MM-DD" æˆ– "å½•åƒæœ€æ—©æ—¥æœŸï¼šYYYY/MM/DD"<br>
                        - "ä¸è¶³30å¤©" æˆ– "ä¸è¶³90å¤©" æˆ– "ä¸è¶³180å¤©"<br>
                        - æ—¥æœŸæ ¼å¼æ”¯æŒï¼š2025-12-01ã€2025/12/01ã€2025-12-1ã€2025/12/1
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <a href="{{.BackURL}}" class="btn btn-secondary">å–æ¶ˆ</a>
            </div>
        </form>
    </div>

    <!-- å®¡æ ¸æ„è§è®°å½•å¼¹çª— -->
    <div id="historyModal" class="history-modal">
        <div class="history-modal-content" id="historyModalContent">
            <div class="history-modal-header" id="historyModalHeader">
                <h3>å®¡æ ¸æ„è§è®°å½•</h3>
                <span class="history-modal-close" onclick="closeAuditHistoryModal()">&times;</span>
            </div>
            <div class="history-modal-body" id="historyModalBody">
                <div class="history-loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶ï¼Œå°†URLä¸­çš„ç­›é€‰æ¡ä»¶å‚æ•°æ·»åŠ åˆ°è¡¨å•ä¸­
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById('editForm');
            var urlParams = new URLSearchParams(window.location.search);
            var filterParams = ['file_name', 'audit_status', 'archive_type', 'sample_status'];
            
            filterParams.forEach(function(param) {
                var value = urlParams.get(param);
                if (value) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = param;
                    input.value = value;
                    form.appendChild(input);
                }
            });
        });

        var currentTaskId = null;
        var isDragging = false;
        var dragOffset = { x: 0, y: 0 };
        var modalContent = null;
        var modalHeader = null;

        // æ‰“å¼€å®¡æ ¸æ„è§è®°å½•å¼¹çª—
        function openAuditHistoryModal(taskId) {
            currentTaskId = taskId;
            var modal = document.getElementById('historyModal');
            modalContent = document.getElementById('historyModalContent');
            modalHeader = document.getElementById('historyModalHeader');
            var modalBody = document.getElementById('historyModalBody');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="history-loading">åŠ è½½ä¸­...</div>';
            
            // é‡ç½®å¼¹çª—ä½ç½®å’Œå¤§å°
            modalContent.style.top = '50%';
            modalContent.style.left = '50%';
            modalContent.style.transform = 'translate(-50%, -50%)';
            modalContent.style.width = '800px';
            modalContent.style.height = '600px';
            
            // åŠ è½½å†å²è®°å½•
            fetch('/audit/progress/history?task_id=' + taskId)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success !== undefined) {
                        if (data.success) {
                            // æˆåŠŸè·å–æ•°æ®
                            if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                                displayHistory(data.data);
                            } else {
                                // æ²¡æœ‰å†å²è®°å½•
                                modalBody.innerHTML = '<div class="history-empty">æ— å†å²å®¡æ ¸è®°å½•</div>';
                            }
                        } else {
                            // APIè¿”å›äº†é”™è¯¯
                            modalBody.innerHTML = '<div class="history-empty">åŠ è½½å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                        }
                    } else {
                        // å“åº”æ ¼å¼ä¸æ­£ç¡®
                        modalBody.innerHTML = '<div class="history-empty">æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = '<div class="history-empty">åŠ è½½å¤±è´¥ï¼š' + error.message + 'ï¼Œè¯·é‡è¯•</div>';
                });
        }

        // å…³é—­å¼¹çª—
        function closeAuditHistoryModal() {
            var modal = document.getElementById('historyModal');
            modal.style.display = 'none';
            currentTaskId = null;
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory(historyList) {
            var modalBody = document.getElementById('historyModalBody');
            
            if (!historyList || historyList.length === 0) {
                modalBody.innerHTML = '<div class="history-empty">æ— å†å²å®¡æ ¸è®°å½•</div>';
                return;
            }
            
            var html = '';
            historyList.forEach(function(item) {
                var statusClass = item.audit_status || '';
                var comment = item.audit_comment || '';
                html += '<div class="history-item">';
                html += '<div class="history-item-header">';
                html += '<span class="history-item-time">' + (item.audit_time || '') + '</span>';
                html += '<div class="history-item-meta">';
                html += '<span>å®¡æ ¸äººï¼š' + (item.auditor || 'ç³»ç»Ÿ') + '</span>';
                html += '<span class="history-item-status ' + statusClass + '">' + (item.audit_status || '') + '</span>';
                html += '</div>';
                html += '</div>';
                html += '<div class="history-item-comment">' + (comment || '') + '</div>';
                html += '</div>';
            });
            
            modalBody.innerHTML = html;
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            var modal = document.getElementById('historyModal');
            if (event.target == modal) {
                closeAuditHistoryModal();
            }
        }

        // æ‹–æ‹½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            modalHeader = document.getElementById('historyModalHeader');
            modalContent = document.getElementById('historyModalContent');
            
            if (modalHeader && modalContent) {
                modalHeader.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('history-modal-close')) {
                        return;
                    }
                    isDragging = true;
                    var rect = modalContent.getBoundingClientRect();
                    dragOffset.x = e.clientX - rect.left;
                    dragOffset.y = e.clientY - rect.top;
                    modalContent.style.cursor = 'move';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    var x = e.clientX - dragOffset.x;
                    var y = e.clientY - dragOffset.y;
                    
                    // é™åˆ¶åœ¨çª—å£å†…
                    var maxX = window.innerWidth - modalContent.offsetWidth;
                    var maxY = window.innerHeight - modalContent.offsetHeight;
                    x = Math.max(0, Math.min(x, maxX));
                    y = Math.max(0, Math.min(y, maxY));
                    
                    modalContent.style.left = x + 'px';
                    modalContent.style.top = y + 'px';
                    modalContent.style.transform = 'none';
                });

                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        if (modalContent) {
                            modalContent.style.cursor = 'default';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>








