<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{.Title}} - æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</title>
    <style>
    body { 
        margin: 0; 
        padding: 0; 
        font-family: "Microsoft YaHei", sans-serif; 
        display: flex; 
        height: 100vh; 
    }
    
    /* å·¦ä¾§å¯¼èˆª */
    .sidebar { 
        width: 180px; 
        background-color: #2c3e50; 
        color: white; 
        display: flex; 
        flex-direction: column; 
    }
    .sidebar h3 { 
        text-align: center; 
        padding: 20px 0; 
        border-bottom: 1px solid #34495e; 
        margin: 0; 
    }
    .menu-item { 
        padding: 15px 20px; 
        color: #ecf0f1; 
        text-decoration: none; 
        display: block; 
        border-bottom: 1px solid #34495e; 
    }
    .menu-item:hover { 
        background-color: #34495e; 
    }
    .menu-item.active { 
        background-color: #3498db; 
    }
    .submenu-item {
        padding: 12px 20px 12px 40px;
        font-size: 14px;
        color: #bdc3c7;
        text-decoration: none;
        display: block;
        border-bottom: 1px solid #34495e;
    }
    .submenu-item:hover {
        background-color: #34495e;
    }
    .submenu-item.active {
        background-color: #2980b9;
        color: white;
    }
    
    .content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    /* æœç´¢å’Œæ“ä½œåŒº */
    .search-container { 
        background: white; 
        padding: 20px; 
        border-radius: 5px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        margin-bottom: 20px; 
        display: flex; 
        flex-direction: column;
        gap: 15px;
    }
    .search-row {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
    }
    .search-row-left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
    }
    .search-row-right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }
    .search-form { 
        display: flex; 
        align-items: center; 
        gap: 8px;
        flex: 1;
        min-width: 0;
    }
    .search-form input, 
    .search-form button, 
    .action-btn { 
        padding: 8px 15px; 
        border-radius: 4px; 
        border: 1px solid #ddd;
    }
    .search-form input { 
        width: 150px; 
        flex-shrink: 0;
    }
    .search-form select {
        flex-shrink: 0;
    }
    .search-form label {
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .search-form button { 
        background-color: #3498db; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    .search-form button:hover { 
        background-color: #2980b9; 
    }

    /* å¯¼å…¥è¡¨å•æ ·å¼ */
    .import-form {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        flex-shrink: 1;
        min-width: 0;
    }
    .import-form label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
        font-size: 13px;
    }
    .import-form input[type="text"] {
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 120px;
        font-size: 13px;
    }
    .import-form input[type="file"] {
        padding: 6px;
        font-size: 13px;
        width: 140px;
    }
    .import-form input[type="checkbox"] {
        margin-right: 3px;
    }
    .import-form select {
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        width: 90px;
    }
    .action-btn {
        padding: 6px 12px;
        font-size: 13px;
        white-space: nowrap;
    }
    .required {
        color: #e74c3c;
    }

    /* å¯¼å…¥/å¯¼å‡ºæŒ‰é’®æ ·å¼ */
    .action-btn { 
        text-decoration: none; 
        color: white; 
        border: none; 
        cursor: pointer;
        display: inline-block;
        text-align: center;
        padding: 8px 15px;
        border-radius: 4px;
    }
    .import-btn { 
        background-color: #f39c12; 
    }
    .import-btn:hover { 
        background-color: #e67e22; 
    }
    .export-btn {
        background-color: #27ae60;
    }
    .export-btn:hover {
        background-color: #229954;
    }
    .template-btn { 
        background-color: #3498db; 
    }
    .template-btn:hover { 
        background-color: #2980b9; 
    }

    /* è¡¨æ ¼ */
    table { 
        width: 100%; 
        border-collapse: collapse; 
        background: white; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    th, td { 
        padding: 12px 15px; 
        text-align: left; 
        border-bottom: 1px solid #eee; 
        font-size: 14px; 
    }
    th { 
        background-color: #f8f9fa; 
        font-weight: 600; 
        color: #2c3e50;
    }
    tr:hover { 
        background-color: #f1f1f1; 
    }

    /* å®¡æ ¸çŠ¶æ€æ ·å¼ */
    .status-pending {
        color: #f39c12;
        font-weight: 600;
    }
    .status-reviewing {
        color: #3498db;
        font-weight: 600;
    }
    .status-completed {
        color: #27ae60;
        font-weight: 600;
    }

    /* æŠ½æ£€çŠ¶æ€æ ·å¼ */
    .sample-status {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
    }
    .sample-status.pending {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .sample-status.completed {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .sample-status.need-fix {
        background-color: #f4e4bc;
        color: #8b6914;
        border: 1px solid #d4a574;
    }
    .sample-btn {
        color: #16a085;
        text-decoration: none;
        margin-right: 10px;
    }
    .sample-btn:hover {
        color: #138d75;
        text-decoration: underline;
    }
    .sample-history-btn {
        color: #8e44ad;
        text-decoration: none;
        margin-right: 10px;
        font-size: 12px;
    }
    .sample-history-btn:hover {
        color: #7d3c98;
        text-decoration: underline;
    }

    /* æ“ä½œä¸‹æ‹‰èœå•æ ·å¼ */
    .action-dropdown {
        position: relative;
        display: inline-block;
    }
    .action-dropdown-btn {
        padding: 6px 12px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        text-decoration: none;
        display: inline-block;
    }
    .action-dropdown-btn:hover {
        background-color: #2980b9;
    }
    /* åœ¨æŒ‰é’®å’Œèœå•ä¹‹é—´åˆ›å»ºä¸€ä¸ªä¸å¯è§çš„è¿æ¥åŒºåŸŸï¼Œé¿å…é¼ æ ‡ç§»åŠ¨æ—¶ç¦»å¼€æ‚¬åœåŒºåŸŸ */
    .action-dropdown::after {
        content: '';
        position: absolute;
        top: 100%;
        right: 0;
        width: 100%;
        height: 8px;
        z-index: 1001;
        background: transparent;
    }
    .action-dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% - 2px);
        background-color: white;
        min-width: 140px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 4px;
        z-index: 1000;
        padding: 4px 0;
        border: 1px solid #ddd;
    }
    /* CSSæ‚¬åœä½œä¸ºå¤‡ç”¨ï¼ŒJavaScriptä¼šæ§åˆ¶æ˜¾ç¤º/éšè— */
    .action-dropdown:hover .action-dropdown-menu {
        display: block;
    }
    .action-dropdown-item {
        display: block;
        padding: 8px 16px;
        color: #333;
        text-decoration: none;
        font-size: 13px;
        white-space: nowrap;
        transition: background-color 0.2s;
    }
    .action-dropdown-item:hover {
        background-color: #f5f5f5;
        color: #2c3e50;
    }
    .action-dropdown-item.detail {
        color: #3498db;
    }
    .action-dropdown-item.edit {
        color: #27ae60;
    }
    .action-dropdown-item.sample {
        color: #16a085;
    }
    .action-dropdown-item.upload {
        color: #9b59b6;
    }
    .action-dropdown-item.delete {
        color: #e74c3c;
    }
    .action-dropdown-divider {
        height: 1px;
        background-color: #eee;
        margin: 4px 0;
    }

    /* æŠ½æ£€å†å²å¼¹çª—æ ·å¼ */
    .history-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .history-modal-content {
        position: absolute;
        background-color: #fefefe;
        border: 1px solid #888;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: 800px;
        height: 600px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        resize: both;
        overflow: hidden;
        min-width: 600px;
        min-height: 400px;
    }
    .history-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
        background-color: #2c3e50;
        color: white;
        cursor: move;
        flex-shrink: 0;
    }
    .history-modal-header h3 {
        margin: 0;
        color: white;
    }
    .history-modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    .history-modal-close:hover,
    .history-modal-close:focus {
        color: white;
    }
    .history-modal-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f5f6fa;
    }
    .history-item {
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        padding: 15px;
        border-left: 4px solid #3498db;
    }
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ecf0f1;
    }
    .history-item-time {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }
    .history-item-meta {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: #7f8c8d;
    }
    .history-item-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    .history-item-status.é€šè¿‡ {
        background-color: #d4edda;
        color: #155724;
    }
    .history-item-status.ä¸é€šè¿‡ {
        background-color: #f8d7da;
        color: #721c24;
    }
    .history-item-status.å¾…æ•´æ”¹ {
        background-color: #fff3cd;
        color: #856404;
    }
    .history-item-comment {
        color: #555;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-top: 10px;
    }
    .history-item-comment:empty::before {
        content: "ï¼ˆæ— æŠ½æ£€æ„è§ï¼‰";
        color: #95a5a6;
        font-style: italic;
    }
    .history-loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }
    .history-empty {
        text-align: center;
        padding: 60px 20px;
        color: #95a5a6;
        font-size: 16px;
    }

    /* æ¡£æ¡ˆç±»å‹æ ‡è¯† */
    .archive-type-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 6px;
        line-height: 1.2;
    }
    .archive-type-new {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .archive-type-take {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .archive-type-supplement {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .archive-type-change {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    /* å•å…µè®¾å¤‡æ ‡è¯† */
    .single-soldier-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #e74c3c;
        border-radius: 50%;
        margin-left: 6px;
        vertical-align: middle;
    }

    /* åˆ†é¡µ */
    .pagination { 
        margin-top: 20px; 
        display: flex; 
        justify-content: flex-end; 
        align-items: center; 
    }
    .page-btn { 
        padding: 5px 15px; 
        border: 1px solid #ddd; 
        background: white; 
        text-decoration: none; 
        color: #333; 
        margin-left: 5px; 
        border-radius: 4px; 
    }
    .page-btn:hover { 
        background-color: #f8f9fa; 
    }
    .page-info {
        margin-right: 15px;
        color: #666;
    }

    /* ä¸Šä¼ æ¨¡æ€æ¡† */
    .upload-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .upload-modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 500px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .upload-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    .upload-modal-header h3 {
        margin: 0;
        color: #2c3e50;
    }
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover,
    .close:focus {
        color: #000;
    }
    .upload-form-group {
        margin-bottom: 15px;
    }
    .upload-form-group label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e50;
        font-weight: 600;
    }
    .upload-form-group input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .upload-form-actions {
        text-align: right;
        margin-top: 20px;
    }
    .upload-btn {
        padding: 8px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }
    .upload-btn:hover {
        background-color: #2980b9;
    }
    .upload-btn-cancel {
        background-color: #95a5a6;
    }
    .upload-btn-cancel:hover {
        background-color: #7f8c8d;
    }

    /* é™„ä»¶æ ‡è¯†æ ·å¼ */
    .attachment-icon {
        display: inline-block;
        margin-left: 8px;
        cursor: pointer;
        position: relative;
        color: #3498db;
        font-size: 16px;
    }
    .attachment-icon:hover {
        color: #2980b9;
    }
    .attachment-tooltip {
        display: none;
        position: absolute;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 10px;
        min-width: 200px;
        max-width: 400px;
        z-index: 1000;
        top: 100%;
        left: 0;
        margin-top: 0;
        pointer-events: auto;
    }
    .attachment-tooltip.show {
        display: block;
    }
    .attachment-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    .attachment-list li {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    .attachment-list li:last-child {
        border-bottom: none;
    }
    .attachment-list a {
        color: #3498db;
        text-decoration: none;
        word-break: break-all;
    }
    .attachment-list a:hover {
        text-decoration: underline;
        color: #2980b9;
    }
    .attachment-header {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ä» Go æ¨¡æ¿ä¸­è·å–ä¼ é€’çš„å‚æ•°
    var msg = '{{.ImportMessage}}';
    var count = {{.ImportCount}};
    var highlightTaskID = {{.HighlightTaskID}};

    if (msg === 'ImportSuccess' && count > 0) {
        alert('å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ' + count + ' æ¡æ•°æ®ã€‚');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            url.searchParams.delete('count');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }
    
    if (msg === 'EditSuccess') {
        alert('å®¡æ ¸æ„è§ä¿å­˜æˆåŠŸï¼');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }

    // å¦‚æœURLä¸­æœ‰task_idå‚æ•°ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°å¯¹åº”çš„ä»»åŠ¡è¡Œå¹¶é«˜äº®
    if (highlightTaskID > 0) {
        var taskRow = document.getElementById('task-' + highlightTaskID);
        if (taskRow) {
            // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é¡µé¢å·²å®Œå…¨æ¸²æŸ“
            setTimeout(function() {
                taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 3ç§’åç§»é™¤é«˜äº®èƒŒæ™¯è‰²
                setTimeout(function() {
                    taskRow.style.backgroundColor = '';
                    taskRow.style.borderLeft = '';
                }, 3000);
            }, 100);
        }
    }
    
    if (msg === 'DeleteSuccess') {
        alert('æ¡£æ¡ˆåˆ é™¤æˆåŠŸï¼');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }

    // éªŒè¯å¯¼å…¥è¡¨å•
    var importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', function(e) {
            var organization = document.getElementById('organization').value.trim();
            var archiveType = document.getElementById('archive_type').value;
            var fileInput = document.getElementById('upload_file');
            
            if (organization === '') {
                alert('æœºæ„åç§°ä¸èƒ½ä¸ºç©ºï¼');
                e.preventDefault();
                return false;
            }
            
            if (archiveType === '') {
                alert('è¯·é€‰æ‹©æ¡£æ¡ˆç±»å‹ï¼');
                e.preventDefault();
                return false;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„Excelæ–‡ä»¶ï¼');
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    }
});

function getStatusClass(status) {
    var statusMap = {
        'å¾…å®¡æ ¸': 'status-pending',
        'å·²å®¡æ ¸å¾…æ•´æ”¹': 'status-reviewing',
        'å·²å®Œæˆ': 'status-completed'
    };
    return statusMap[status] || '';
}

// ç¡®è®¤åˆ é™¤æ¡£æ¡ˆ
function confirmDelete(taskId, fileName) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ¡£æ¡ˆ"' + fileName + '"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æ¡£æ¡ˆçš„æ‰€æœ‰æ˜ç»†è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ï¼')) {
        // åˆ›å»ºè¡¨å•æäº¤åˆ é™¤è¯·æ±‚
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/audit/progress/delete';
        
        // æ·»åŠ task_idå‚æ•°
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'task_id';
        input.value = taskId;
        form.appendChild(input);
        
        // ä¿ç•™æŸ¥è¯¢å‚æ•°
        var searchName = new URLSearchParams(window.location.search).get('file_name');
        if (searchName) {
            var searchInput = document.createElement('input');
            searchInput.type = 'hidden';
            searchInput.name = 'file_name';
            searchInput.value = searchName;
            form.appendChild(searchInput);
        }
        var auditStatus = new URLSearchParams(window.location.search).get('audit_status');
        if (auditStatus) {
            var statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'audit_status';
            statusInput.value = auditStatus;
            form.appendChild(statusInput);
        }
        var archiveType = new URLSearchParams(window.location.search).get('archive_type');
        if (archiveType) {
            var archiveTypeInput = document.createElement('input');
            archiveTypeInput.type = 'hidden';
            archiveTypeInput.name = 'archive_type';
            archiveTypeInput.value = archiveType;
            form.appendChild(archiveTypeInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</head>
<body>
    <div class="sidebar">
        <h3>æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</h3>
        <a href="/stats" class="menu-item {{if eq .ActiveMenu "stats"}}active{{end}}">ç»Ÿè®¡ä¿¡æ¯</a>
        <a href="/device/filelist" class="menu-item {{if eq .ActiveMenu "filelist"}}active{{end}}">å»ºæ¡£æ˜ç»†</a>
        <a href="/device/filelist" class="submenu-item {{if eq .SubMenu "device_filelist"}}active{{end}}">è®¾å¤‡å»ºæ¡£æ˜ç»†</a>
        <a href="/checkpoint/filelist" class="submenu-item {{if eq .SubMenu "checkpoint_filelist"}}active{{end}}">å¡å£å»ºæ¡£æ˜ç»†</a>
        <a href="/audit" class="menu-item {{if eq .ActiveMenu "audit"}}active{{end}}">æ¡£æ¡ˆå®¡æ ¸</a>
        <a href="/audit/progress" class="submenu-item {{if eq .SubMenu "audit_progress"}}active{{end}}">è®¾å¤‡å®¡æ ¸è¿›åº¦</a>
        <a href="/audit/progress/video-reminders" class="submenu-item {{if eq .SubMenu "video_reminders"}}active{{end}}">å½•åƒå¤©æ•°ä¸è¶³æé†’</a>
        <a href="/checkpoint/progress" class="submenu-item {{if eq .SubMenu "checkpoint_progress"}}active{{end}}">å¡å£å®¡æ ¸è¿›åº¦</a>
        <a href="/audit/statistics" class="submenu-item {{if eq .SubMenu "audit_statistics"}}active{{end}}">æœˆåº¦å»ºæ¡£æ•°æ®</a>
        <a href="/users" class="menu-item {{if eq .ActiveMenu "settings"}}active{{end}}">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/users" class="submenu-item {{if eq .SubMenu "users"}}active{{end}}">ç”¨æˆ·ä¿¡æ¯</a>
        <a href="/permission" class="submenu-item {{if eq .SubMenu "permission"}}active{{end}}">æƒé™è®¾ç½®</a>
        <a href="/taskconfig" class="submenu-item {{if eq .SubMenu "task_config"}}active{{end}}">ä»»åŠ¡é…ç½®</a>
        <a href="/logs" class="submenu-item {{if eq .SubMenu "logs"}}active{{end}}">æ“ä½œæ—¥å¿—</a>
    </div>

    <div class="content">
    <h1>è®¾å¤‡å®¡æ ¸è¿›åº¦</h1>
    
    <!-- æœç´¢å’Œæ“ä½œåŒº -->
    <div class="search-container">
        <!-- ç¬¬ä¸€è¡Œï¼šæŸ¥è¯¢åŠŸèƒ½ -->
        <div class="search-row">
            <form class="search-form" action="/audit/progress" method="GET" style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
            <input type="text" name="file_name" placeholder="è¾“å…¥æ¡£æ¡ˆåç§°" value="{{.SearchName}}">
            <label style="font-weight: 600; color: #2c3e50; margin: 0 5px;">å®¡æ ¸çŠ¶æ€:</label>
            <select name="audit_status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">å…¨éƒ¨</option>
                <option value="æœªå®¡æ ¸" {{if eq .AuditStatus "æœªå®¡æ ¸"}}selected{{end}}>æœªå®¡æ ¸</option>
                <option value="å·²å®¡æ ¸å¾…æ•´æ”¹" {{if eq .AuditStatus "å·²å®¡æ ¸å¾…æ•´æ”¹"}}selected{{end}}>å·²å®¡æ ¸å¾…æ•´æ”¹</option>
                <option value="å·²å®Œæˆ" {{if eq .AuditStatus "å·²å®Œæˆ"}}selected{{end}}>å·²å®Œæˆ</option>
            </select>
            <label style="font-weight: 600; color: #2c3e50; margin: 0 5px;">å»ºæ¡£ç±»å‹:</label>
            <select name="archive_type" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">å…¨éƒ¨</option>
                <option value="æ–°å¢" {{if eq .ArchiveType "æ–°å¢"}}selected{{end}}>æ–°å¢</option>
                <option value="å–æ¨" {{if eq .ArchiveType "å–æ¨"}}selected{{end}}>å–æ¨</option>
                <option value="è¡¥æ¡£æ¡ˆ" {{if eq .ArchiveType "è¡¥æ¡£æ¡ˆ"}}selected{{end}}>è¡¥æ¡£æ¡ˆ</option>
                <option value="å˜æ›´" {{if eq .ArchiveType "å˜æ›´"}}selected{{end}}>å˜æ›´</option>
            </select>
            <label style="font-weight: 600; color: #2c3e50; margin: 0 5px;">æŠ½æ£€çŠ¶æ€:</label>
            <select name="sample_status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">å…¨éƒ¨</option>
                <option value="å·²æŠ½æ£€" {{if eq .SampleStatus "å·²æŠ½æ£€"}}selected{{end}}>å·²æŠ½æ£€</option>
                <option value="æœªæŠ½æ£€" {{if eq .SampleStatus "æœªæŠ½æ£€"}}selected{{end}}>æœªæŠ½æ£€</option>
            </select>
            <button type="submit">æŸ¥è¯¢</button>
            {{if or .SearchName .AuditStatus .ArchiveType .SampleStatus}}
            <a href="/audit/progress" style="padding: 8px 15px; background-color: #95a5a6; color: white; text-decoration: none; border-radius: 4px;">æ¸…é™¤</a>
            {{end}}
            </form>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šå¯¼å…¥åŠŸèƒ½ -->
        {{if .CanImport}}
        <div class="search-row" style="display: flex; align-items: center; gap: 8px;">
            <a href="/audit/progress/download-template" class="action-btn template-btn" style="white-space: nowrap; flex-shrink: 0;">ä¸‹è½½æ¨¡æ¿</a>
            <form id="importForm" class="import-form" action="/audit/progress/import" method="POST" enctype="multipart/form-data" style="display: flex; align-items: center; gap: 6px; padding: 8px; background: #f8f9fa; border-radius: 4px; flex: 1; min-width: 0;">
                <label>æœºæ„<span class="required">*</span>:</label>
                <input type="text" id="organization" name="organization" placeholder="æœºæ„åç§°" required>
                <label style="white-space: nowrap;">
                    <input type="checkbox" id="is_single_soldier" name="is_single_soldier" value="1">
                    å•å…µè®¾å¤‡
                </label>
                <label>ç±»å‹<span class="required">*</span>:</label>
                <select id="archive_type" name="archive_type" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="æ–°å¢">æ–°å¢</option>
                    <option value="å–æ¨">å–æ¨</option>
                    <option value="è¡¥æ¡£æ¡ˆ">è¡¥æ¡£æ¡ˆ</option>
                    <option value="å˜æ›´">å˜æ›´</option>
                </select>
                <input type="file" id="upload_file" name="upload_file" accept=".xlsx,.xls" required>
                <button type="submit" class="action-btn import-btn">å¯¼å…¥</button>
            </form>
        </div>
        {{end}}

    <!-- æ•°æ®è¡¨æ ¼ -->
    <table>
        <thead>
            <tr>
                    <th>åºå·</th>
                    <th>æ¡£æ¡ˆåç§°</th>
                    <th>å®¡æ ¸çŠ¶æ€</th>
                    <th>æŠ½æ£€çŠ¶æ€</th>
                    <th>å®¡æ ¸æ„è§</th>
                    <th>å®¡æ ¸æ—¶é—´</th>
                    <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {{if .List}}
                {{range $index, $task := .List}}
                <tr id="task-{{$task.ID}}" data-task-id="{{$task.ID}}" {{if eq $.HighlightTaskID $task.ID}}style="background-color: #fff3cd; border-left: 4px solid #ffc107;"{{end}}>
                    <td>{{$task.ID}}</td>
                    <td>{{$task.FileName}}</td>
                    <td>
                        <span class="{{if eq $task.AuditStatus "æœªå®¡æ ¸"}}status-pending{{else if eq $task.AuditStatus "å·²å®¡æ ¸å¾…æ•´æ”¹"}}status-reviewing{{else if eq $task.AuditStatus "å·²å®Œæˆ"}}status-completed{{end}}">
                            {{$task.AuditStatus}}
                        </span>
                        {{if gt $task.ReminderCount 0}}
                        <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background-color: #e74c3c; color: white; border-radius: 10px; font-size: 11px; font-weight: 600;" title="æœ‰{{$task.ReminderCount}}ä¸ªå½•åƒæé†’">
                            âš ï¸ {{$task.ReminderCount}}
                        </span>
                        {{end}}
                        {{if $task.ArchiveType.Valid}}
                            {{if eq $task.ArchiveType.String "æ–°å¢"}}
                            <span class="archive-type-badge archive-type-new">æ–°</span>
                            {{else if eq $task.ArchiveType.String "å–æ¨"}}
                            <span class="archive-type-badge archive-type-take">å–</span>
                            {{else if eq $task.ArchiveType.String "è¡¥æ¡£æ¡ˆ"}}
                            <span class="archive-type-badge archive-type-supplement">è¡¥</span>
                            {{else if eq $task.ArchiveType.String "å˜æ›´"}}
                            <span class="archive-type-badge archive-type-change">å˜</span>
                            {{end}}
                        {{end}}
                        {{if eq $task.IsSingleSoldier 1}}
                        <span class="single-soldier-dot" title="å•å…µè®¾å¤‡"></span>
                        {{end}}
                        <span style="margin-left: 8px; color: #666; font-size: 12px;">({{$task.RecordCount}}æ¡)</span>
                        {{if $task.Attachments}}
                        <span class="attachment-icon" title="æœ‰é™„ä»¶" onmouseenter="showAttachmentTooltip(this)" onmouseleave="hideAttachmentTooltip(this)">
                            ğŸ“˜
                            <div class="attachment-tooltip" onmouseenter="showAttachmentTooltip(this.parentElement)" onmouseleave="hideAttachmentTooltip(this.parentElement)">
                                <div class="attachment-header">é™„ä»¶åˆ—è¡¨</div>
                                <ul class="attachment-list">
                                    {{range $task.Attachments}}
                                    <li>
                                        <a href="#" onclick="downloadAttachment({{$task.ID}}, '{{.}}'); return false;" target="_blank">{{.}}</a>
                                    </li>
                                    {{end}}
                                </ul>
                            </div>
                        </span>
                        {{end}}
                    </td>
                    <td>
                        {{if eq $task.AuditStatus "å·²å®Œæˆ"}}
                            {{if $task.IsSampled}}
                                {{if eq $task.LastSampleResult "å¾…æ•´æ”¹"}}
                                <span class="sample-status need-fix" title="æŠ½æ£€äººï¼š{{$task.SampledBy}}&#10;æœ€è¿‘ä¸€æ¬¡æŠ½æ£€æ—¶é—´ï¼š{{$task.LastSampledAt}}&#10;æŠ½æ£€æ¬¡æ•°ï¼š{{$task.SampleCount}}æ¬¡&#10;æœ€è¿‘ä¸€æ¬¡æŠ½æ£€ç»“æœï¼š{{$task.LastSampleResult}}">
                                    å·²æŠ½æ£€{{if gt $task.SampleCount 1}}({{$task.SampleCount}}){{end}}
                                </span>
                                {{else}}
                                <span class="sample-status completed" title="æŠ½æ£€äººï¼š{{$task.SampledBy}}&#10;æœ€è¿‘ä¸€æ¬¡æŠ½æ£€æ—¶é—´ï¼š{{$task.LastSampledAt}}&#10;æŠ½æ£€æ¬¡æ•°ï¼š{{$task.SampleCount}}æ¬¡&#10;æœ€è¿‘ä¸€æ¬¡æŠ½æ£€ç»“æœï¼š{{if $task.LastSampleResult}}{{$task.LastSampleResult}}{{else}}é€šè¿‡{{end}}">
                                    å·²æŠ½æ£€{{if gt $task.SampleCount 1}}({{$task.SampleCount}}){{end}}
                                </span>
                                {{end}}
                            {{else}}
                                <span class="sample-status pending">å¾…æŠ½æ£€</span>
                            {{end}}
                        {{else}}
                            <span style="color: #999;">-</span>
                        {{end}}
                    </td>
                    <td>
                        {{if $task.AuditComment.Valid}}
                            {{$task.AuditComment.String}}
                        {{else}}
                            <span style="color: #999;">-</span>
                        {{end}}
                    </td>
                    <td>{{$task.UpdatedAt}}</td>
                    <td>
                        <div class="action-dropdown">
                            <a href="#" class="action-dropdown-btn">æ“ä½œ â–¼</a>
                            <div class="action-dropdown-menu">
                                <a href="{{$task.DetailURL}}" class="action-dropdown-item detail">æŸ¥çœ‹æ˜ç»†</a>
                                <a href="{{$task.EditURL}}" class="action-dropdown-item edit">ç¼–è¾‘</a>
                                {{if eq $task.AuditStatus "å·²å®Œæˆ"}}
                                <a href="{{$task.SampleURL}}" class="action-dropdown-item sample">æŠ½æ£€</a>
                                {{end}}
                                <a href="#" onclick="openUploadModal({{$task.ID}}, '{{$task.FileName}}'); return false;" class="action-dropdown-item upload">ä¸Šä¼ æ–‡ä»¶</a>
                                {{if $.CanDelete}}
                                <div class="action-dropdown-divider"></div>
                                <a href="#" onclick="confirmDelete({{$task.ID}}, '{{$task.FileName}}'); return false;" class="action-dropdown-item delete">åˆ é™¤</a>
                                {{end}}
                            </div>
                        </div>
                    </td>
                </tr>
                {{end}}
            {{else}}
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                        æš‚æ— æ•°æ®
                    </td>
                </tr>
            {{end}}
        </tbody>
    </table>

    <!-- åˆ†é¡µ -->
    <div class="pagination">
        {{if gt .TotalCount 0}}
        <span class="page-info">æ˜¾ç¤ºç¬¬ {{.StartRecord}}-{{.EndRecord}} æ¡ï¼Œå…± {{.TotalCount}} æ¡è®°å½• | ç¬¬ {{.CurrentPage}} / {{.TotalPages}} é¡µ</span>
        {{else}}
        <span class="page-info">æš‚æ— è®°å½•</span>
        {{end}}
        {{if gt .TotalPages 1}}
            {{if gt .CurrentPage .FirstPage}}
            <a href="/audit/progress?page={{.FirstPage}}{{if ne .Query ""}}&{{.Query}}{{end}}" class="page-btn">é¦–é¡µ</a>
            {{end}}
            {{if .HasPrev}}
            <a href="/audit/progress?page={{.PrevPage}}{{if ne .Query ""}}&{{.Query}}{{end}}" class="page-btn">ä¸Šä¸€é¡µ</a>
            {{end}}
            {{if .HasNext}}
            <a href="/audit/progress?page={{.NextPage}}{{if ne .Query ""}}&{{.Query}}{{end}}" class="page-btn">ä¸‹ä¸€é¡µ</a>
            {{end}}
            {{if lt .CurrentPage .LastPage}}
            <a href="/audit/progress?page={{.LastPage}}{{if ne .Query ""}}&{{.Query}}{{end}}" class="page-btn">æœ€åä¸€é¡µ</a>
            {{end}}
        {{end}}
    </div>
    </div>

    <!-- ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" id="uploadTaskId" name="task_id" value="">
                <div class="upload-form-group">
                    <label>æ¡£æ¡ˆåç§°ï¼š</label>
                    <div id="uploadFileName" style="color: #666; margin-bottom: 10px;"></div>
                </div>
                <div class="upload-form-group">
                    <label>ä¸Šä¼ ç±»å‹ï¼š</label>
                    <div style="margin-bottom: 10px;">
                        <label style="display: inline-flex; align-items: center; margin-right: 20px; cursor: pointer;">
                            <input type="radio" name="uploadType" value="file" id="uploadTypeFile" checked onchange="switchUploadType()" style="margin-right: 5px;">
                            <span>ä¸Šä¼ æ–‡ä»¶</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="uploadType" value="directory" id="uploadTypeDirectory" onchange="switchUploadType()" style="margin-right: 5px;">
                            <span>ä¸Šä¼ ç›®å½•</span>
                        </label>
                    </div>
                    <label for="uploadFileInput" id="uploadFileLabel">é€‰æ‹©æ–‡ä»¶ï¼š</label>
                    <input type="file" id="uploadFileInput" name="upload_file" multiple required>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;" id="uploadTypeHint">
                        æ”¯æŒé€‰æ‹©å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼ˆæœ€å¤š20ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°ä¸è¶…è¿‡200MBï¼‰
                    </div>
                </div>
                <div id="uploadFileInfo" style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;">
                    <div style="font-size: 13px; color: #333; margin-bottom: 5px;"><strong>å·²é€‰æ‹©ï¼š</strong></div>
                    <div id="fileList" style="font-size: 12px; color: #666; max-height: 100px; overflow-y: auto;"></div>
                    <div id="fileSizeInfo" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                </div>
                <div id="uploadProgress" style="display: none; margin: 10px 0;">
                    <div style="font-size: 13px; color: #333; margin-bottom: 5px;"><strong>ä¸Šä¼ è¿›åº¦ï¼š</strong></div>
                    <div style="background: #e0e0e0; border-radius: 4px; height: 20px; position: relative; overflow: hidden;">
                        <div id="progressBar" style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;"></div>
                    </div>
                    <div id="progressText" style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;"></div>
                </div>
                <div class="upload-form-actions">
                    <button type="button" class="upload-btn upload-btn-cancel" onclick="closeUploadModal()">å–æ¶ˆ</button>
                    <button type="submit" class="upload-btn" id="uploadSubmitBtn">ä¸Šä¼ </button>
                </div>
            </form>
        </div>
    </div>

    </div>

    <script>
    // åˆ‡æ¢ä¸Šä¼ ç±»å‹
    function switchUploadType() {
        var fileInput = document.getElementById('uploadFileInput');
        var fileLabel = document.getElementById('uploadFileLabel');
        var typeHint = document.getElementById('uploadTypeHint');
        var uploadTypeFile = document.getElementById('uploadTypeFile');
        
        // æ¸…ç©ºå½“å‰é€‰æ‹©
        fileInput.value = '';
        document.getElementById('uploadFileInfo').style.display = 'none';
        
        if (uploadTypeFile.checked) {
            // æ–‡ä»¶æ¨¡å¼ï¼šç§»é™¤ webkitdirectoryï¼Œä¿ç•™ multiple
            fileInput.removeAttribute('webkitdirectory');
            fileInput.setAttribute('multiple', 'multiple');
            fileLabel.textContent = 'é€‰æ‹©æ–‡ä»¶ï¼š';
            typeHint.textContent = 'æ”¯æŒé€‰æ‹©å•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼ˆæœ€å¤š20ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°ä¸è¶…è¿‡200MBï¼‰';
        } else {
            // ç›®å½•æ¨¡å¼ï¼šæ·»åŠ  webkitdirectory
            fileInput.setAttribute('webkitdirectory', 'webkitdirectory');
            fileInput.setAttribute('multiple', 'multiple');
            fileLabel.textContent = 'é€‰æ‹©ç›®å½•ï¼š';
            typeHint.textContent = 'æ”¯æŒé€‰æ‹©æ•´ä¸ªç›®å½•ä¸Šä¼ ï¼ˆæœ€å¤š20ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°ä¸è¶…è¿‡200MBï¼‰';
        }
    }

    // æ‰“å¼€ä¸Šä¼ æ¨¡æ€æ¡†
    function openUploadModal(taskId, fileName) {
        document.getElementById('uploadTaskId').value = taskId;
        document.getElementById('uploadFileName').textContent = fileName;
        document.getElementById('uploadModal').style.display = 'block';
        document.getElementById('uploadFileInput').value = '';
        document.getElementById('uploadFileInfo').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('fileSizeInfo').textContent = '';
        // é‡ç½®ä¸ºæ–‡ä»¶æ¨¡å¼
        document.getElementById('uploadTypeFile').checked = true;
        switchUploadType();
    }

    // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    document.getElementById('uploadFileInput').addEventListener('change', function(e) {
        var files = e.target.files;
        var fileInfoDiv = document.getElementById('uploadFileInfo');
        var fileListDiv = document.getElementById('fileList');
        var fileSizeInfoDiv = document.getElementById('fileSizeInfo');
        
        if (files.length === 0) {
            fileInfoDiv.style.display = 'none';
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶
        if (files.length > 20) {
            alert('æ–‡ä»¶æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œæœ€å¤šå…è®¸ä¸Šä¼ 20ä¸ªæ–‡ä»¶ï¼Œå½“å‰é€‰æ‹©äº†' + files.length + 'ä¸ª');
            e.target.value = '';
            fileInfoDiv.style.display = 'none';
            return;
        }

        // è®¡ç®—æ€»å¤§å°
        var totalSize = 0;
        var fileList = [];
        for (var i = 0; i < files.length; i++) {
            totalSize += files[i].size;
            fileList.push(files[i].name + ' (' + formatFileSize(files[i].size) + ')');
        }

        // æ£€æŸ¥æ€»å¤§å°é™åˆ¶ï¼ˆ200MBï¼‰
        var maxSize = 200 * 1024 * 1024; // 200MB
        if (totalSize > maxSize) {
            alert('æ€»æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼Œæœ€å¤§å…è®¸200MBï¼Œå½“å‰æ€»å¤§å°ä¸º' + formatFileSize(totalSize));
            e.target.value = '';
            fileInfoDiv.style.display = 'none';
            return;
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        fileListDiv.innerHTML = fileList.join('<br>');
        fileSizeInfoDiv.textContent = 'å…± ' + files.length + ' ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å°ï¼š' + formatFileSize(totalSize);
        fileInfoDiv.style.display = 'block';
    });

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        var k = 1024;
        var sizes = ['B', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
    function closeUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
        document.getElementById('uploadForm').reset();
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        var modal = document.getElementById('uploadModal');
        if (event.target == modal) {
            closeUploadModal();
        }
    }

    // å¤„ç†ä¸Šä¼ è¡¨å•æäº¤
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var uploadBtn = document.getElementById('uploadSubmitBtn');
        var originalText = uploadBtn.textContent;
        var progressDiv = document.getElementById('uploadProgress');
        var progressBar = document.getElementById('progressBar');
        var progressText = document.getElementById('progressText');
        
        // è·å–æ–‡ä»¶æ•°é‡
        var files = document.getElementById('uploadFileInput').files;
        var totalFiles = files.length;
        
        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºä¸Šä¼ ä¸­
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        progressDiv.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
        
        // ä½¿ç”¨XMLHttpRequestä»¥ä¾¿æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        var xhr = new XMLHttpRequest();
        
        // ä¸Šä¼ è¿›åº¦äº‹ä»¶
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                var percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                progressText.textContent = 'ä¸Šä¼ ä¸­ï¼š' + percentComplete + '% (' + formatFileSize(e.loaded) + ' / ' + formatFileSize(e.total) + ')';
            }
        });
        
        // è¯·æ±‚å®Œæˆäº‹ä»¶
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼æˆåŠŸï¼š' + (data.successCount || totalFiles) + '/' + (data.total || totalFiles);
                        
                        var message = 'ä¸Šä¼ å®Œæˆï¼\næˆåŠŸï¼š' + (data.successCount || totalFiles) + '/' + (data.total || totalFiles);
                        if (data.failedCount && data.failedCount > 0) {
                            message += '\nå¤±è´¥ï¼š' + data.failedCount;
                            if (data.failedFiles && data.failedFiles.length > 0) {
                                message += '\nå¤±è´¥æ–‡ä»¶ï¼š' + data.failedFiles.join(', ');
                            }
                        }
                        
                        setTimeout(function() {
                            alert(message);
                            closeUploadModal();
                            // åˆ·æ–°é¡µé¢
                            window.location.reload();
                        }, 500);
                    } else {
                        progressText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯');
                        alert('ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = originalText;
                    }
                } catch (e) {
                    progressText.textContent = 'è§£æå“åº”å¤±è´¥';
                    alert('ä¸Šä¼ å¤±è´¥ï¼šè§£æå“åº”å¤±è´¥');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = originalText;
                }
            } else {
                try {
                    var errorData = JSON.parse(xhr.responseText);
                    progressText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼š' + (errorData.message || 'æœªçŸ¥é”™è¯¯');
                    alert('ä¸Šä¼ å¤±è´¥ï¼š' + (errorData.message || 'æœªçŸ¥é”™è¯¯'));
                } catch (e) {
                    progressText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + xhr.status;
                    alert('ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + xhr.status);
                }
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        });
        
        // è¯·æ±‚é”™è¯¯äº‹ä»¶
        xhr.addEventListener('error', function() {
            progressText.textContent = 'ç½‘ç»œé”™è¯¯';
            alert('ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        });
        
        // è¯·æ±‚ä¸­æ­¢äº‹ä»¶
        xhr.addEventListener('abort', function() {
            progressText.textContent = 'ä¸Šä¼ å·²å–æ¶ˆ';
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        });
        
        // å‘é€è¯·æ±‚
        xhr.open('POST', '/audit/progress/upload');
        xhr.send(formData);
    });

    // ä¸‹è½½é™„ä»¶
    function downloadAttachment(taskId, fileName) {
        var url = '/audit/progress/download?task_id=' + taskId + '&file_name=' + encodeURIComponent(fileName);
        window.open(url, '_blank');
    }

    // é™„ä»¶æ‚¬åœçª—å£ç®¡ç†
    var attachmentTooltipTimers = {};

    // æ˜¾ç¤ºé™„ä»¶æ‚¬åœçª—å£
    function showAttachmentTooltip(container) {
        // è·å–å®¹å™¨IDæˆ–ä½¿ç”¨å”¯ä¸€æ ‡è¯†
        var containerId = container.getAttribute('data-tooltip-id');
        if (!containerId) {
            containerId = 'tooltip_' + Math.random().toString(36).substr(2, 9);
            container.setAttribute('data-tooltip-id', containerId);
        }
        
        // æ¸…é™¤è¯¥å®¹å™¨çš„éšè—å®šæ—¶å™¨
        if (attachmentTooltipTimers[containerId]) {
            clearTimeout(attachmentTooltipTimers[containerId]);
            delete attachmentTooltipTimers[containerId];
        }
        
        var tooltip = container.querySelector('.attachment-tooltip');
        if (tooltip) {
            tooltip.classList.add('show');
        }
    }

    // éšè—é™„ä»¶æ‚¬åœçª—å£
    function hideAttachmentTooltip(container) {
        var containerId = container.getAttribute('data-tooltip-id');
        if (!containerId) {
            containerId = 'tooltip_' + Math.random().toString(36).substr(2, 9);
            container.setAttribute('data-tooltip-id', containerId);
        }
        
        var tooltip = container.querySelector('.attachment-tooltip');
        if (tooltip) {
            // æ·»åŠ å°å»¶è¿Ÿï¼Œå…è®¸é¼ æ ‡ç§»åŠ¨åˆ°tooltipä¸Š
            attachmentTooltipTimers[containerId] = setTimeout(function() {
                tooltip.classList.remove('show');
                delete attachmentTooltipTimers[containerId];
            }, 150);
        }
    }
    </script>

    <!-- æŠ½æ£€å†å²å¼¹çª— -->
    <div id="sampleHistoryModal" class="history-modal">
        <div class="history-modal-content" id="sampleHistoryModalContent">
            <div class="history-modal-header" id="sampleHistoryModalHeader">
                <h3>æŠ½æ£€å†å²è®°å½•</h3>
                <span class="history-modal-close" onclick="closeSampleHistoryModal()">&times;</span>
            </div>
            <div class="history-modal-body" id="sampleHistoryModalBody">
                <div class="history-loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // æŠ½æ£€å†å²å¼¹çª—ç›¸å…³å˜é‡
        var currentSampleTaskId = null;
        var isSampleDragging = false;
        var sampleDragOffset = { x: 0, y: 0 };
        var sampleModalContent = null;
        var sampleModalHeader = null;

        // æ‰“å¼€æŠ½æ£€å†å²å¼¹çª—
        function openSampleHistoryModal(taskId) {
            currentSampleTaskId = taskId;
            var modal = document.getElementById('sampleHistoryModal');
            sampleModalContent = document.getElementById('sampleHistoryModalContent');
            sampleModalHeader = document.getElementById('sampleHistoryModalHeader');
            var modalBody = document.getElementById('sampleHistoryModalBody');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="history-loading">åŠ è½½ä¸­...</div>';
            
            // é‡ç½®å¼¹çª—ä½ç½®å’Œå¤§å°
            sampleModalContent.style.top = '50%';
            sampleModalContent.style.left = '50%';
            sampleModalContent.style.transform = 'translate(-50%, -50%)';
            sampleModalContent.style.width = '800px';
            sampleModalContent.style.height = '600px';
            
            // åŠ è½½æŠ½æ£€å†å²è®°å½•
            fetch('/audit/progress/sample/history?task_id=' + taskId)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success !== undefined) {
                        if (data.success) {
                            // æˆåŠŸè·å–æ•°æ®
                            if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                                displaySampleHistory(data.data);
                            } else {
                                // æ²¡æœ‰å†å²è®°å½•
                                modalBody.innerHTML = '<div class="history-empty">æ— æŠ½æ£€å†å²è®°å½•</div>';
                            }
                        } else {
                            // APIè¿”å›äº†é”™è¯¯
                            modalBody.innerHTML = '<div class="history-empty">åŠ è½½å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                        }
                    } else {
                        // å“åº”æ ¼å¼ä¸æ­£ç¡®
                        modalBody.innerHTML = '<div class="history-empty">æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = '<div class="history-empty">åŠ è½½å¤±è´¥ï¼š' + error.message + 'ï¼Œè¯·é‡è¯•</div>';
                });
        }

        // å…³é—­æŠ½æ£€å†å²å¼¹çª—
        function closeSampleHistoryModal() {
            var modal = document.getElementById('sampleHistoryModal');
            modal.style.display = 'none';
            currentSampleTaskId = null;
        }

        // æ˜¾ç¤ºæŠ½æ£€å†å²è®°å½•
        function displaySampleHistory(historyList) {
            var modalBody = document.getElementById('sampleHistoryModalBody');
            
            if (!historyList || historyList.length === 0) {
                modalBody.innerHTML = '<div class="history-empty">æ— æŠ½æ£€å†å²è®°å½•</div>';
                return;
            }
            
            var html = '';
            historyList.forEach(function(item) {
                var resultClass = item.sample_result || '';
                var comment = item.sample_comment || '';
                var result = item.sample_result || '';
                
                html += '<div class="history-item">';
                html += '<div class="history-item-header">';
                html += '<span class="history-item-time">' + (item.sampled_at || '') + '</span>';
                html += '<div class="history-item-meta">';
                html += '<span>æŠ½æ£€äººï¼š' + (item.sampled_by || '') + '</span>';
                if (result) {
                    html += '<span class="history-item-status ' + resultClass + '">' + result + '</span>';
                }
                html += '</div>';
                html += '</div>';
                html += '<div class="history-item-comment">' + (comment || 'ï¼ˆæ— æŠ½æ£€æ„è§ï¼‰') + '</div>';
                html += '</div>';
            });
            
            modalBody.innerHTML = html;
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            var modal = document.getElementById('sampleHistoryModal');
            if (event.target == modal) {
                closeSampleHistoryModal();
            }
        });

        // æŠ½æ£€å†å²å¼¹çª—æ‹–æ‹½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            sampleModalHeader = document.getElementById('sampleHistoryModalHeader');
            sampleModalContent = document.getElementById('sampleHistoryModalContent');
            
            if (sampleModalHeader && sampleModalContent) {
                sampleModalHeader.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('history-modal-close')) {
                        return;
                    }
                    isSampleDragging = true;
                    var rect = sampleModalContent.getBoundingClientRect();
                    sampleDragOffset.x = e.clientX - rect.left;
                    sampleDragOffset.y = e.clientY - rect.top;
                    sampleModalContent.style.cursor = 'move';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', function(e) {
                    if (!isSampleDragging) return;
                    
                    var x = e.clientX - sampleDragOffset.x;
                    var y = e.clientY - sampleDragOffset.y;
                    
                    // é™åˆ¶åœ¨çª—å£å†…
                    var maxX = window.innerWidth - sampleModalContent.offsetWidth;
                    var maxY = window.innerHeight - sampleModalContent.offsetHeight;
                    x = Math.max(0, Math.min(x, maxX));
                    y = Math.max(0, Math.min(y, maxY));
                    
                    sampleModalContent.style.left = x + 'px';
                    sampleModalContent.style.top = y + 'px';
                    sampleModalContent.style.transform = 'none';
                });

                document.addEventListener('mouseup', function() {
                    if (isSampleDragging) {
                        isSampleDragging = false;
                        if (sampleModalContent) {
                            sampleModalContent.style.cursor = 'default';
                        }
                    }
                });
            }
        });
    </script>

    <script>
        // æ“ä½œä¸‹æ‹‰èœå•ç¨³å®šæ€§ä¼˜åŒ– - ä½¿ç”¨å»¶è¿Ÿéšè—æœºåˆ¶
        document.addEventListener('DOMContentLoaded', function() {
            var dropdowns = document.querySelectorAll('.action-dropdown');
            var hideTimers = {};
            
            dropdowns.forEach(function(dropdown, index) {
                var menu = dropdown.querySelector('.action-dropdown-menu');
                var dropdownId = 'dropdown-' + index;
                
                // é¼ æ ‡è¿›å…¥ä¸‹æ‹‰åŒºåŸŸ
                dropdown.addEventListener('mouseenter', function() {
                    // æ¸…é™¤éšè—å®šæ—¶å™¨
                    if (hideTimers[dropdownId]) {
                        clearTimeout(hideTimers[dropdownId]);
                        delete hideTimers[dropdownId];
                    }
                    // æ˜¾ç¤ºèœå•
                    menu.style.display = 'block';
                });
                
                // é¼ æ ‡ç¦»å¼€ä¸‹æ‹‰åŒºåŸŸ
                dropdown.addEventListener('mouseleave', function(e) {
                    // æ£€æŸ¥é¼ æ ‡æ˜¯å¦çœŸçš„ç¦»å¼€äº†æ•´ä¸ªä¸‹æ‹‰åŒºåŸŸï¼ˆåŒ…æ‹¬èœå•ï¼‰
                    var relatedTarget = e.relatedTarget;
                    if (!dropdown.contains(relatedTarget)) {
                        // å»¶è¿Ÿéšè—ï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»åŠ¨é¼ æ ‡åˆ°èœå•
                        hideTimers[dropdownId] = setTimeout(function() {
                            menu.style.display = 'none';
                            delete hideTimers[dropdownId];
                        }, 200); // 200mså»¶è¿Ÿ
                    }
                });
                
                // é¼ æ ‡è¿›å…¥èœå•
                menu.addEventListener('mouseenter', function() {
                    // æ¸…é™¤éšè—å®šæ—¶å™¨
                    if (hideTimers[dropdownId]) {
                        clearTimeout(hideTimers[dropdownId]);
                        delete hideTimers[dropdownId];
                    }
                    menu.style.display = 'block';
                });
                
                // é¼ æ ‡ç¦»å¼€èœå•
                menu.addEventListener('mouseleave', function(e) {
                    var relatedTarget = e.relatedTarget;
                    if (!dropdown.contains(relatedTarget)) {
                        // å»¶è¿Ÿéšè—
                        hideTimers[dropdownId] = setTimeout(function() {
                            menu.style.display = 'none';
                            delete hideTimers[dropdownId];
                        }, 200);
                    }
                });
            });
        });
    </script>

    <!-- SSEå®æ—¶æ›´æ–° -->
    <script>
        (function() {
            // è·å–å½“å‰é¡µé¢çš„ç­›é€‰æ¡ä»¶
            function getCurrentFilters() {
                const params = new URLSearchParams(window.location.search);
                return {
                    page: params.get('page') || '1',
                    file_name: params.get('file_name') || '',
                    audit_status: params.get('audit_status') || '',
                    archive_type: params.get('archive_type') || '',
                    sample_status: params.get('sample_status') || ''
                };
            }

            // æ„å»ºSSE URL
            function buildSSEUrl() {
                const filters = getCurrentFilters();
                const params = new URLSearchParams();
                if (filters.page) params.set('page', filters.page);
                if (filters.file_name) params.set('file_name', filters.file_name);
                if (filters.audit_status) params.set('audit_status', filters.audit_status);
                if (filters.archive_type) params.set('archive_type', filters.archive_type);
                if (filters.sample_status) params.set('sample_status', filters.sample_status);
                
                const query = params.toString();
                return '/audit/progress/events' + (query ? '?' + query : '');
            }

            // æ›´æ–°ä»»åŠ¡è¡Œ
            function updateTaskRow(taskId, data) {
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (!row) {
                    // å¦‚æœä»»åŠ¡ä¸åœ¨å½“å‰é¡µï¼Œåˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                    console.log('[SSE] ä»»åŠ¡ä¸åœ¨å½“å‰é¡µï¼Œåˆ·æ–°åˆ—è¡¨');
                    window.location.reload();
                    return;
                }

                console.log('[SSE] æ›´æ–°ä»»åŠ¡è¡Œ:', taskId, data);

                // æ›´æ–°å®¡æ ¸çŠ¶æ€ - åœ¨ç¬¬ä¸‰åˆ—ï¼ˆtd:nth-child(3)ï¼‰
                if (data.audit_status) {
                    const statusTd = row.querySelector('td:nth-child(3)');
                    if (statusTd) {
                        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªspanï¼ˆçŠ¶æ€spanï¼‰
                        const statusSpan = statusTd.querySelector('span');
                        if (statusSpan) {
                            statusSpan.textContent = data.audit_status;
                            // æ›´æ–°ç±»å
                            statusSpan.className = getStatusClass(data.audit_status);
                            console.log('[SSE] å®¡æ ¸çŠ¶æ€å·²æ›´æ–°:', data.audit_status);
                            
                            // å¦‚æœå®¡æ ¸çŠ¶æ€æ›´æ–°ä¸º"å·²å®Œæˆ"ï¼Œéœ€è¦æ›´æ–°æŠ½æ£€çŠ¶æ€åˆ—
                            if (data.audit_status === 'å·²å®Œæˆ') {
                                // æ£€æŸ¥å½“å‰æŠ½æ£€çŠ¶æ€åˆ—ï¼Œå¦‚æœæ˜¾ç¤º"-"ï¼Œåˆ™æ›´æ–°ä¸º"å¾…æŠ½æ£€"
                                const sampleTd = row.querySelector('td:nth-child(4)');
                                if (sampleTd) {
                                    const currentSampleText = sampleTd.textContent.trim();
                                    // å¦‚æœå½“å‰æ˜¾ç¤º"-"æˆ–ä¸ºç©ºï¼Œåˆ™æ›´æ–°ä¸º"å¾…æŠ½æ£€"
                                    if (currentSampleText === '-' || currentSampleText === '') {
                                        sampleTd.innerHTML = '<span class="sample-status pending">å¾…æŠ½æ£€</span>';
                                        console.log('[SSE] æŠ½æ£€çŠ¶æ€åˆ—å·²æ›´æ–°ä¸º"å¾…æŠ½æ£€"');
                                    }
                                }
                            } else {
                                // å¦‚æœå®¡æ ¸çŠ¶æ€ä¸æ˜¯"å·²å®Œæˆ"ï¼ŒæŠ½æ£€çŠ¶æ€åˆ—åº”è¯¥æ˜¾ç¤º"-"
                                const sampleTd = row.querySelector('td:nth-child(4)');
                                if (sampleTd) {
                                    sampleTd.innerHTML = '<span style="color: #999;">-</span>';
                                }
                            }
                        } else {
                            console.warn('[SSE] æœªæ‰¾åˆ°çŠ¶æ€spanï¼Œtdå†…å®¹:', statusTd.innerHTML);
                        }
                    } else {
                        console.warn('[SSE] æœªæ‰¾åˆ°çŠ¶æ€td');
                    }
                }

                // æ›´æ–°å®¡æ ¸æ„è§ - åœ¨ç¬¬äº”åˆ—ï¼ˆtd:nth-child(5)ï¼‰
                if (data.audit_comment !== undefined) {
                    const commentTd = row.querySelector('td:nth-child(5)');
                    if (commentTd) {
                        if (data.audit_comment && data.audit_comment.trim() !== '') {
                            commentTd.textContent = data.audit_comment;
                        } else {
                            commentTd.innerHTML = '<span style="color: #999;">-</span>';
                        }
                        console.log('[SSE] å®¡æ ¸æ„è§å·²æ›´æ–°:', data.audit_comment);
                    } else {
                        console.warn('[SSE] æœªæ‰¾åˆ°å®¡æ ¸æ„è§td');
                    }
                }
                
                // æ›´æ–°æŠ½æ£€çŠ¶æ€ï¼ˆå¦‚æœäº‹ä»¶ä¸­åŒ…å«æŠ½æ£€ä¿¡æ¯ï¼‰
                if (data.sample_result !== undefined) {
                    const sampleTd = row.querySelector('td:nth-child(4)');
                    if (sampleTd) {
                        // æ£€æŸ¥å®¡æ ¸çŠ¶æ€æ˜¯å¦ä¸º"å·²å®Œæˆ"
                        const auditStatusTd = row.querySelector('td:nth-child(3)');
                        const auditStatusSpan = auditStatusTd ? auditStatusTd.querySelector('span') : null;
                        const currentAuditStatus = auditStatusSpan ? auditStatusSpan.textContent.trim() : '';
                        
                        if (currentAuditStatus === 'å·²å®Œæˆ') {
                            // å¦‚æœå·²æŠ½æ£€ï¼Œæ˜¾ç¤ºæŠ½æ£€çŠ¶æ€
                            if (data.sample_result === 'å¾…æ•´æ”¹') {
                                sampleTd.innerHTML = '<span class="sample-status need-fix" title="æŠ½æ£€ç»“æœï¼šå¾…æ•´æ”¹">å·²æŠ½æ£€</span>';
                            } else {
                                sampleTd.innerHTML = '<span class="sample-status completed" title="æŠ½æ£€ç»“æœï¼šé€šè¿‡">å·²æŠ½æ£€</span>';
                            }
                            console.log('[SSE] æŠ½æ£€çŠ¶æ€å·²æ›´æ–°:', data.sample_result);
                        }
                    }
                }
                
                // æ·»åŠ æ›´æ–°åŠ¨ç”»æ•ˆæœ
                row.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 2000);
            }

            // è·å–çŠ¶æ€æ ·å¼ç±»
            function getStatusClass(status) {
                const statusMap = {
                    'æœªå®¡æ ¸': 'status-pending',
                    'å·²å®¡æ ¸å¾…æ•´æ”¹': 'status-reviewing',
                    'å·²å®Œæˆ': 'status-completed'
                };
                return statusMap[status] || 'status-pending';
            }

            // åˆ é™¤ä»»åŠ¡è¡Œ
            function removeTaskRow(taskId) {
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°åˆ†é¡µä¿¡æ¯
                        window.location.reload();
                    }, 500);
                }
            }

            // è¿æ¥SSE
            let eventSource = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;

            function connectSSE() {
                if (eventSource) {
                    eventSource.close();
                }

                const url = buildSSEUrl();
                eventSource = new EventSource(url);

                eventSource.onopen = function() {
                    console.log('[SSE] è¿æ¥å·²å»ºç«‹ï¼ŒURL:', url);
                    reconnectAttempts = 0;
                };

                eventSource.onmessage = function(event) {
                    console.log('[SSE] æ”¶åˆ°åŸå§‹äº‹ä»¶æ•°æ®:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        console.log('[SSE] è§£æåçš„äº‹ä»¶æ•°æ®:', data);

                        switch(data.type) {
                            case 'connected':
                                console.log('[SSE] è¿æ¥æˆåŠŸ');
                                break;
                            
                            case 'heartbeat':
                                // å¿ƒè·³ï¼Œä¸åšå¤„ç†
                                break;
                            
                            case 'task_created':
                                // æ–°ä»»åŠ¡åˆ›å»ºï¼Œåˆ·æ–°åˆ—è¡¨
                                console.log('[SSE] æ–°ä»»åŠ¡åˆ›å»º:', data.task_id);
                                window.location.reload();
                                break;
                            
                            case 'task_updated':
                                // ä»»åŠ¡æ›´æ–°
                                console.log('[SSE] ä»»åŠ¡æ›´æ–°:', data.task_id, data.data);
                                updateTaskRow(data.task_id, data.data);
                                break;
                            
                            case 'task_deleted':
                                // ä»»åŠ¡åˆ é™¤
                                console.log('[SSE] ä»»åŠ¡åˆ é™¤:', data.task_id);
                                removeTaskRow(data.task_id);
                                break;
                            
                            case 'task_sampled':
                                // ä»»åŠ¡æŠ½æ£€
                                console.log('[SSE] ä»»åŠ¡æŠ½æ£€:', data.task_id, data.data);
                                updateTaskRow(data.task_id, data.data);
                                break;
                            
                            case 'task_refreshed':
                                // éœ€è¦åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                                console.log('[SSE] åˆ·æ–°åˆ—è¡¨');
                                window.location.reload();
                                break;
                            
                            default:
                                console.log('[SSE] æœªçŸ¥äº‹ä»¶ç±»å‹:', data.type);
                        }
                    } catch (e) {
                        console.error('[SSE] è§£æäº‹ä»¶æ•°æ®å¤±è´¥:', e, event.data);
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('[SSE] è¿æ¥é”™è¯¯:', error, 'readyState:', eventSource.readyState);
                    // readyState: 0=CONNECTING, 1=OPEN, 2=CLOSED
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('[SSE] è¿æ¥å·²å…³é—­');
                    }
                    eventSource.close();

                    // è‡ªåŠ¨é‡è¿
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000); // æŒ‡æ•°é€€é¿ï¼Œæœ€å¤š30ç§’
                        console.log(`[SSE] ${delay/1000}ç§’åå°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`);
                        setTimeout(connectSSE, delay);
                    } else {
                        console.error('[SSE] è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                    }
                };
            }

            // é¡µé¢åŠ è½½æ—¶è¿æ¥SSE
            if (typeof EventSource !== 'undefined') {
                connectSSE();

                // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
                window.addEventListener('beforeunload', function() {
                    if (eventSource) {
                        eventSource.close();
                    }
                });

                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†è¿æ¥
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        // é¡µé¢éšè—æ—¶ä¿æŒè¿æ¥ï¼ˆå¯é€‰ï¼šå¯ä»¥å…³é—­ä»¥èŠ‚çœèµ„æºï¼‰
                    } else {
                        // é¡µé¢æ˜¾ç¤ºæ—¶ç¡®ä¿è¿æ¥
                        if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                            connectSSE();
                        }
                    }
                });
            } else {
                console.warn('[SSE] æµè§ˆå™¨ä¸æ”¯æŒEventSourceï¼Œå®æ—¶æ›´æ–°åŠŸèƒ½ä¸å¯ç”¨');
            }
        })();
    </script>

    </div>
</body>
</html>







