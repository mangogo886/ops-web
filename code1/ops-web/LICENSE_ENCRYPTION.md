# 许可文件加密说明

## 概述

许可文件现已采用 **AES-256-CBC** 加密存储，防止手动修改。

## 加密方式

- **加密算法**：AES-256-CBC
- **密钥**：硬编码在代码中（编译后无法轻易修改）
- **IV**：每次加密随机生成（存储在加密数据中）
- **编码**：Base64编码

## 文件格式

### 加密前（JSON格式）
```json
{
    "expireDate": "2026-12-30",
    "macAddress": "00:11:22:33:44:55",
    "issueDate": "2024-12-20",
    "licenseKey": ""
}
```

### 加密后（文件内容）
```
base64编码的加密数据（不可读，无法直接修改）
```

## 安全特性

1. ✅ **防止手动修改**：文件内容已加密，无法直接编辑
2. ✅ **必须使用工具生成**：只能通过 `license-generator.exe` 工具生成有效的许可文件
3. ✅ **密钥保护**：加密密钥硬编码在代码中，编译后无法轻易提取

## 使用说明

### 生成加密许可文件

使用许可生成工具生成加密的许可文件：

```bash
license-generator.exe -expire 2026-12-30 -mac 00:11:22:33:44:55 -output config/license.json
```

生成的 `config/license.json` 文件将是加密的，无法直接查看或修改内容。

### 系统自动解密

系统启动时和用户登录时会自动：
1. 读取加密的许可文件
2. 解密文件内容
3. 验证许可信息（日期、MAC地址等）

**用户无需手动操作**，系统会自动处理加密/解密。

## 注意事项

### ⚠️ 重要提示

1. **不能手动编辑许可文件**
   - 文件已加密，手动编辑会导致文件损坏
   - 系统无法解密损坏的许可文件，会拒绝登录

2. **只能使用工具生成**
   - 必须使用 `license-generator.exe` 工具生成许可文件
   - 不能直接创建或编辑 `config/license.json` 文件

3. **工具密钥必须匹配**
   - 许可生成工具和系统使用相同的加密密钥
   - 如果密钥不匹配，系统无法解密许可文件

4. **文件损坏处理**
   - 如果许可文件损坏（如手动编辑），系统会提示"解密许可文件失败"
   - 需要重新使用工具生成新的许可文件

## 常见错误

### 错误：解密许可文件失败

**原因**：
- 许可文件被手动修改
- 许可文件损坏
- 使用了不匹配的工具生成（密钥不一致）

**解决方法**：
1. 删除损坏的许可文件
2. 使用 `license-generator.exe` 重新生成许可文件

### 错误：解析许可文件失败

**原因**：
- 解密后的数据格式不正确
- 文件不是由正确的工具生成

**解决方法**：
- 使用正确的 `license-generator.exe` 工具重新生成

## 技术细节

### 加密流程（工具生成）

```
JSON数据
  ↓
序列化（JSON Marshal）
  ↓
AES-256-CBC加密
  ↓
Base64编码
  ↓
写入文件
```

### 解密流程（系统验证）

```
读取文件
  ↓
Base64解码
  ↓
AES-256-CBC解密
  ↓
JSON反序列化
  ↓
验证许可信息
```

## 安全性说明

### 当前保护级别

- ✅ **基础保护**：防止普通用户手动修改许可文件
- ✅ **格式保护**：加密后无法直接查看JSON内容
- ✅ **工具限制**：必须使用工具生成，无法手动创建

### 限制说明

- ⚠️ **密钥硬编码**：加密密钥硬编码在代码中
- ⚠️ **静态密钥**：所有许可文件使用相同的密钥（但每次加密的IV不同）
- ⚠️ **编译后可见**：密钥存在于编译后的二进制文件中（需要逆向工程才能提取）

### 适用场景

当前加密方案适用于：
- ✅ 防止普通用户手动修改许可文件
- ✅ 防止简单的文本编辑修改许可
- ✅ 要求必须使用工具生成许可

**不适用于**：
- ❌ 防止专业逆向工程师破解（需要更复杂的方案）
- ❌ 防止密钥被提取（密钥在代码中）

---

**更新日期**：2024-12-20  
**版本**：1.0（加密版本）

