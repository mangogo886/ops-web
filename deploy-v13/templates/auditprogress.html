<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{.Title}} - æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</title>
    <style>
    body { 
        margin: 0; 
        padding: 0; 
        font-family: "Microsoft YaHei", sans-serif; 
        display: flex; 
        height: 100vh; 
    }
    
    /* å·¦ä¾§å¯¼èˆª */
    .sidebar { 
        width: 220px; 
        background-color: #2c3e50; 
        color: white; 
        display: flex; 
        flex-direction: column; 
    }
    .sidebar h3 { 
        text-align: center; 
        padding: 20px 0; 
        border-bottom: 1px solid #34495e; 
        margin: 0; 
    }
    .menu-item { 
        padding: 15px 20px; 
        color: #ecf0f1; 
        text-decoration: none; 
        display: block; 
        border-bottom: 1px solid #34495e; 
    }
    .menu-item:hover { 
        background-color: #34495e; 
    }
    .menu-item.active { 
        background-color: #3498db; 
    }
    .submenu-item {
        padding: 12px 20px 12px 40px;
        font-size: 14px;
        color: #bdc3c7;
        text-decoration: none;
        display: block;
        border-bottom: 1px solid #34495e;
    }
    .submenu-item:hover {
        background-color: #34495e;
    }
    .submenu-item.active {
        background-color: #2980b9;
        color: white;
    }
    
    .content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    /* æœç´¢å’Œæ“ä½œåŒº */
    .search-container { 
        background: white; 
        padding: 20px; 
        border-radius: 5px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        margin-bottom: 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        flex-wrap: nowrap;
        gap: 15px;
        overflow: hidden;
    }
    .search-form { 
        display: flex; 
        align-items: center; 
        gap: 8px;
        flex: 0 1 auto;
        min-width: 0;
    }
    .search-form input, 
    .search-form button, 
    .action-btn { 
        padding: 8px 15px; 
        border-radius: 4px; 
        border: 1px solid #ddd;
    }
    .search-form input { 
        width: 150px; 
        flex-shrink: 0;
    }
    .search-form select {
        flex-shrink: 0;
    }
    .search-form label {
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .search-form button { 
        background-color: #3498db; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    .search-form button:hover { 
        background-color: #2980b9; 
    }

    /* å¯¼å…¥è¡¨å•æ ·å¼ */
    .import-form {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        flex-shrink: 1;
        min-width: 0;
    }
    .import-form label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
        font-size: 13px;
    }
    .import-form input[type="text"] {
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 120px;
        font-size: 13px;
    }
    .import-form input[type="file"] {
        padding: 6px;
        font-size: 13px;
        width: 140px;
    }
    .import-form input[type="checkbox"] {
        margin-right: 3px;
    }
    .import-form select {
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        width: 90px;
    }
    .action-btn {
        padding: 6px 12px;
        font-size: 13px;
        white-space: nowrap;
    }
    .required {
        color: #e74c3c;
    }

    /* å¯¼å…¥/å¯¼å‡ºæŒ‰é’®æ ·å¼ */
    .action-btn { 
        text-decoration: none; 
        color: white; 
        border: none; 
        cursor: pointer;
        display: inline-block;
        text-align: center;
        padding: 8px 15px;
        border-radius: 4px;
    }
    .import-btn { 
        background-color: #f39c12; 
    }
    .import-btn:hover { 
        background-color: #e67e22; 
    }
    .export-btn {
        background-color: #27ae60;
    }
    .export-btn:hover {
        background-color: #229954;
    }
    .template-btn { 
        background-color: #3498db; 
    }
    .template-btn:hover { 
        background-color: #2980b9; 
    }

    /* è¡¨æ ¼ */
    table { 
        width: 100%; 
        border-collapse: collapse; 
        background: white; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    th, td { 
        padding: 12px 15px; 
        text-align: left; 
        border-bottom: 1px solid #eee; 
        font-size: 14px; 
    }
    th { 
        background-color: #f8f9fa; 
        font-weight: 600; 
        color: #2c3e50;
    }
    tr:hover { 
        background-color: #f1f1f1; 
    }

    /* å®¡æ ¸çŠ¶æ€æ ·å¼ */
    .status-pending {
        color: #f39c12;
        font-weight: 600;
    }
    .status-reviewing {
        color: #3498db;
        font-weight: 600;
    }
    .status-completed {
        color: #27ae60;
        font-weight: 600;
    }

    /* æ¡£æ¡ˆç±»å‹æ ‡è¯† */
    .archive-type-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 6px;
        line-height: 1.2;
    }
    .archive-type-new {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .archive-type-take {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .archive-type-supplement {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    /* å•å…µè®¾å¤‡æ ‡è¯† */
    .single-soldier-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #e74c3c;
        border-radius: 50%;
        margin-left: 6px;
        vertical-align: middle;
    }

    /* åˆ†é¡µ */
    .pagination { 
        margin-top: 20px; 
        display: flex; 
        justify-content: flex-end; 
        align-items: center; 
    }
    .page-btn { 
        padding: 5px 15px; 
        border: 1px solid #ddd; 
        background: white; 
        text-decoration: none; 
        color: #333; 
        margin-left: 5px; 
        border-radius: 4px; 
    }
    .page-btn:hover { 
        background-color: #f8f9fa; 
    }
    .page-info {
        margin-right: 15px;
        color: #666;
    }

    /* ä¸Šä¼ æ¨¡æ€æ¡† */
    .upload-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .upload-modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 500px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .upload-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    .upload-modal-header h3 {
        margin: 0;
        color: #2c3e50;
    }
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover,
    .close:focus {
        color: #000;
    }
    .upload-form-group {
        margin-bottom: 15px;
    }
    .upload-form-group label {
        display: block;
        margin-bottom: 5px;
        color: #2c3e50;
        font-weight: 600;
    }
    .upload-form-group input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .upload-form-actions {
        text-align: right;
        margin-top: 20px;
    }
    .upload-btn {
        padding: 8px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }
    .upload-btn:hover {
        background-color: #2980b9;
    }
    .upload-btn-cancel {
        background-color: #95a5a6;
    }
    .upload-btn-cancel:hover {
        background-color: #7f8c8d;
    }

    /* é™„ä»¶æ ‡è¯†æ ·å¼ */
    .attachment-icon {
        display: inline-block;
        margin-left: 8px;
        cursor: pointer;
        position: relative;
        color: #3498db;
        font-size: 16px;
    }
    .attachment-icon:hover {
        color: #2980b9;
    }
    .attachment-tooltip {
        display: none;
        position: absolute;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 10px;
        min-width: 200px;
        max-width: 400px;
        z-index: 1000;
        top: 100%;
        left: 0;
        margin-top: 0;
        pointer-events: auto;
    }
    .attachment-tooltip.show {
        display: block;
    }
    .attachment-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    .attachment-list li {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    .attachment-list li:last-child {
        border-bottom: none;
    }
    .attachment-list a {
        color: #3498db;
        text-decoration: none;
        word-break: break-all;
    }
    .attachment-list a:hover {
        text-decoration: underline;
        color: #2980b9;
    }
    .attachment-header {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid #ddd;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ä» Go æ¨¡æ¿ä¸­è·å–ä¼ é€’çš„å‚æ•°
    var msg = '{{.ImportMessage}}';
    var count = {{.ImportCount}};

    if (msg === 'ImportSuccess' && count > 0) {
        alert('å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ' + count + ' æ¡æ•°æ®ã€‚');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            url.searchParams.delete('count');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }
    
    if (msg === 'EditSuccess') {
        alert('å®¡æ ¸æ„è§ä¿å­˜æˆåŠŸï¼');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }
    
    if (msg === 'DeleteSuccess') {
        alert('æ¡£æ¡ˆåˆ é™¤æˆåŠŸï¼');
        
        // æ¸…é™¤ URL ä¸­çš„å‚æ•°ï¼Œé˜²æ­¢åˆ·æ–°é‡å¤å¼¹çª—
        if (window.history.replaceState) {
            var url = new URL(window.location.href);
            url.searchParams.delete('message');
            window.history.replaceState({path:url.href}, '', url.href);
        }
    }

    // éªŒè¯å¯¼å…¥è¡¨å•
    var importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', function(e) {
            var organization = document.getElementById('organization').value.trim();
            var archiveType = document.getElementById('archive_type').value;
            var fileInput = document.getElementById('upload_file');
            
            if (organization === '') {
                alert('æœºæ„åç§°ä¸èƒ½ä¸ºç©ºï¼');
                e.preventDefault();
                return false;
            }
            
            if (archiveType === '') {
                alert('è¯·é€‰æ‹©æ¡£æ¡ˆç±»å‹ï¼');
                e.preventDefault();
                return false;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„Excelæ–‡ä»¶ï¼');
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    }
});

function getStatusClass(status) {
    var statusMap = {
        'å¾…å®¡æ ¸': 'status-pending',
        'å·²å®¡æ ¸å¾…æ•´æ”¹': 'status-reviewing',
        'å·²å®Œæˆ': 'status-completed'
    };
    return statusMap[status] || '';
}

// ç¡®è®¤åˆ é™¤æ¡£æ¡ˆ
function confirmDelete(taskId, fileName) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ¡£æ¡ˆ"' + fileName + '"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥æ¡£æ¡ˆçš„æ‰€æœ‰æ˜ç»†è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ï¼')) {
        // åˆ›å»ºè¡¨å•æäº¤åˆ é™¤è¯·æ±‚
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/audit/progress/delete';
        
        // æ·»åŠ task_idå‚æ•°
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'task_id';
        input.value = taskId;
        form.appendChild(input);
        
        // ä¿ç•™æŸ¥è¯¢å‚æ•°
        var searchName = new URLSearchParams(window.location.search).get('file_name');
        if (searchName) {
            var searchInput = document.createElement('input');
            searchInput.type = 'hidden';
            searchInput.name = 'file_name';
            searchInput.value = searchName;
            form.appendChild(searchInput);
        }
        var auditStatus = new URLSearchParams(window.location.search).get('audit_status');
        if (auditStatus) {
            var statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'audit_status';
            statusInput.value = auditStatus;
            form.appendChild(statusInput);
        }
        var archiveType = new URLSearchParams(window.location.search).get('archive_type');
        if (archiveType) {
            var archiveTypeInput = document.createElement('input');
            archiveTypeInput.type = 'hidden';
            archiveTypeInput.name = 'archive_type';
            archiveTypeInput.value = archiveType;
            form.appendChild(archiveTypeInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</head>
<body>
    <div class="sidebar">
        <h3>æ¡£æ¡ˆå®¡æ ¸ç®¡ç†</h3>
        <a href="/stats" class="menu-item {{if eq .ActiveMenu "stats"}}active{{end}}">ç»Ÿè®¡ä¿¡æ¯</a>
        <a href="/device/filelist" class="menu-item {{if eq .ActiveMenu "filelist"}}active{{end}}">å»ºæ¡£æ˜ç»†</a>
        <a href="/device/filelist" class="submenu-item {{if eq .SubMenu "device_filelist"}}active{{end}}">è®¾å¤‡å»ºæ¡£æ˜ç»†</a>
        <a href="/checkpoint/filelist" class="submenu-item {{if eq .SubMenu "checkpoint_filelist"}}active{{end}}">å¡å£å»ºæ¡£æ˜ç»†</a>
        <a href="/audit" class="menu-item {{if eq .ActiveMenu "audit"}}active{{end}}">æ¡£æ¡ˆå®¡æ ¸</a>
        <a href="/audit/progress" class="submenu-item {{if eq .SubMenu "audit_progress"}}active{{end}}">è®¾å¤‡å®¡æ ¸è¿›åº¦</a>
        <a href="/checkpoint/progress" class="submenu-item {{if eq .SubMenu "checkpoint_progress"}}active{{end}}">å¡å£å®¡æ ¸è¿›åº¦</a>
        <a href="/audit/statistics" class="submenu-item {{if eq .SubMenu "audit_statistics"}}active{{end}}">æœˆåº¦å»ºæ¡£æ•°æ®</a>
        <a href="/users" class="menu-item {{if eq .ActiveMenu "settings"}}active{{end}}">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/users" class="submenu-item {{if eq .SubMenu "users"}}active{{end}}">ç”¨æˆ·ä¿¡æ¯</a>
        <a href="/taskconfig" class="submenu-item {{if eq .SubMenu "task_config"}}active{{end}}">ä»»åŠ¡é…ç½®</a>
        <a href="/logs" class="submenu-item {{if eq .SubMenu "logs"}}active{{end}}">æ“ä½œæ—¥å¿—</a>
    </div>

    <div class="content">
    <h1>è®¾å¤‡å®¡æ ¸è¿›åº¦</h1>
    
    <!-- æœç´¢å’Œæ“ä½œåŒº -->
    <div class="search-container">
        <form class="search-form" action="/audit/progress" method="GET">
            <input type="text" name="file_name" placeholder="è¾“å…¥æ¡£æ¡ˆåç§°" value="{{.SearchName}}">
            <label style="font-weight: 600; color: #2c3e50; margin: 0 5px;">å®¡æ ¸çŠ¶æ€:</label>
            <select name="audit_status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">å…¨éƒ¨</option>
                <option value="æœªå®¡æ ¸" {{if eq .AuditStatus "æœªå®¡æ ¸"}}selected{{end}}>æœªå®¡æ ¸</option>
                <option value="å·²å®¡æ ¸å¾…æ•´æ”¹" {{if eq .AuditStatus "å·²å®¡æ ¸å¾…æ•´æ”¹"}}selected{{end}}>å·²å®¡æ ¸å¾…æ•´æ”¹</option>
                <option value="å·²å®Œæˆ" {{if eq .AuditStatus "å·²å®Œæˆ"}}selected{{end}}>å·²å®Œæˆ</option>
            </select>
            <label style="font-weight: 600; color: #2c3e50; margin: 0 5px;">å»ºæ¡£ç±»å‹:</label>
            <select name="archive_type" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">å…¨éƒ¨</option>
                <option value="æ–°å¢" {{if eq .ArchiveType "æ–°å¢"}}selected{{end}}>æ–°å¢</option>
                <option value="å–æ¨" {{if eq .ArchiveType "å–æ¨"}}selected{{end}}>å–æ¨</option>
                <option value="è¡¥æ¡£æ¡ˆ" {{if eq .ArchiveType "è¡¥æ¡£æ¡ˆ"}}selected{{end}}>è¡¥æ¡£æ¡ˆ</option>
            </select>
            <button type="submit">æŸ¥è¯¢</button>
            {{if or .SearchName .AuditStatus .ArchiveType}}
            <a href="/audit/progress" style="padding: 8px 15px; background-color: #95a5a6; color: white; text-decoration: none; border-radius: 4px;">æ¸…é™¤</a>
            {{end}}
        </form>

        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0;">
            <a href="/audit/progress/download-template" class="action-btn template-btn" style="white-space: nowrap;">ä¸‹è½½æ¨¡æ¿</a>
            <form id="importForm" class="import-form" action="/audit/progress/import" method="POST" enctype="multipart/form-data">
                <label>æœºæ„<span class="required">*</span>:</label>
                <input type="text" id="organization" name="organization" placeholder="æœºæ„åç§°" required>
                <label style="white-space: nowrap;">
                    <input type="checkbox" id="is_single_soldier" name="is_single_soldier" value="1">
                    å•å…µè®¾å¤‡
                </label>
                <label>ç±»å‹<span class="required">*</span>:</label>
                <select id="archive_type" name="archive_type" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="æ–°å¢">æ–°å¢</option>
                    <option value="å–æ¨">å–æ¨</option>
                    <option value="è¡¥æ¡£æ¡ˆ">è¡¥æ¡£æ¡ˆ</option>
                </select>
                <input type="file" id="upload_file" name="upload_file" accept=".xlsx,.xls" required>
                <button type="submit" class="action-btn import-btn">å¯¼å…¥</button>
            </form>
        </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <table>
        <thead>
            <tr>
                    <th>åºå·</th>
                    <th>æ¡£æ¡ˆåç§°</th>
                    <th>æœºæ„åç§°</th>
                    <th>å¯¼å…¥æ—¶é—´</th>
                    <th>å®¡æ ¸çŠ¶æ€</th>
                    <th>å®¡æ ¸æ„è§</th>
                    <th>å®¡æ ¸æ—¶é—´</th>
                    <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {{if .List}}
                {{range $index, $task := .List}}
                <tr>
                    <td>{{$task.ID}}</td>
                    <td>{{$task.FileName}}</td>
                    <td>{{$task.Organization}}</td>
                    <td>{{$task.ImportTime}}</td>
                    <td>
                        <span class="{{if eq $task.AuditStatus "æœªå®¡æ ¸"}}status-pending{{else if eq $task.AuditStatus "å·²å®¡æ ¸å¾…æ•´æ”¹"}}status-reviewing{{else if eq $task.AuditStatus "å·²å®Œæˆ"}}status-completed{{end}}">
                            {{$task.AuditStatus}}
                        </span>
                        {{if $task.ArchiveType.Valid}}
                            {{if eq $task.ArchiveType.String "æ–°å¢"}}
                            <span class="archive-type-badge archive-type-new">æ–°</span>
                            {{else if eq $task.ArchiveType.String "å–æ¨"}}
                            <span class="archive-type-badge archive-type-take">å–</span>
                            {{else if eq $task.ArchiveType.String "è¡¥æ¡£æ¡ˆ"}}
                            <span class="archive-type-badge archive-type-supplement">è¡¥</span>
                            {{end}}
                        {{end}}
                        {{if eq $task.IsSingleSoldier 1}}
                        <span class="single-soldier-dot" title="å•å…µè®¾å¤‡"></span>
                        {{end}}
                        <span style="margin-left: 8px; color: #666; font-size: 12px;">({{$task.RecordCount}}æ¡)</span>
                        {{if $task.Attachments}}
                        <span class="attachment-icon" title="æœ‰é™„ä»¶" onmouseenter="showAttachmentTooltip(this)" onmouseleave="hideAttachmentTooltip(this)">
                            ğŸ“
                            <div class="attachment-tooltip" onmouseenter="showAttachmentTooltip(this.parentElement)" onmouseleave="hideAttachmentTooltip(this.parentElement)">
                                <div class="attachment-header">é™„ä»¶åˆ—è¡¨</div>
                                <ul class="attachment-list">
                                    {{range $task.Attachments}}
                                    <li>
                                        <a href="#" onclick="downloadAttachment({{$task.ID}}, '{{.}}'); return false;" target="_blank">{{.}}</a>
                                    </li>
                                    {{end}}
                                </ul>
                            </div>
                        </span>
                        {{end}}
                    </td>
                    <td>
                        {{if $task.AuditComment.Valid}}
                            {{$task.AuditComment.String}}
                        {{else}}
                            <span style="color: #999;">-</span>
                        {{end}}
                    </td>
                    <td>{{$task.UpdatedAt}}</td>
                    <td>
                        <a href="/audit/progress/detail?task_id={{$task.ID}}" style="color: #3498db; text-decoration: none; margin-right: 10px;">æŸ¥çœ‹æ˜ç»†</a>
                        <a href="/audit/progress/edit?task_id={{$task.ID}}" style="color: #27ae60; text-decoration: none; margin-right: 10px;">ç¼–è¾‘</a>
                        <a href="#" onclick="openUploadModal({{$task.ID}}, '{{$task.FileName}}'); return false;" style="color: #9b59b6; text-decoration: none; margin-right: 10px;">ä¸Šä¼ æ–‡ä»¶</a>
                        <a href="#" onclick="confirmDelete({{$task.ID}}, '{{$task.FileName}}'); return false;" style="color: #e74c3c; text-decoration: none;">åˆ é™¤</a>
                    </td>
                </tr>
                {{end}}
            {{else}}
                <tr>
                    <td colspan="8" style="text-align: center; color: #999; padding: 40px;">
                        æš‚æ— æ•°æ®
                    </td>
                </tr>
            {{end}}
        </tbody>
    </table>

    <!-- åˆ†é¡µ -->
    {{if gt .TotalPages 1}}
    <div class="pagination">
        <span class="page-info">ç¬¬ {{.CurrentPage}} / {{.TotalPages}} é¡µ</span>
        {{if gt .CurrentPage .FirstPage}}
        <a href="/audit/progress?page={{.FirstPage}}{{if .Query}}&{{.Query}}{{end}}" class="page-btn">é¦–é¡µ</a>
        {{end}}
        {{if .HasPrev}}
        <a href="/audit/progress?page={{.PrevPage}}{{if .Query}}&{{.Query}}{{end}}" class="page-btn">ä¸Šä¸€é¡µ</a>
        {{end}}
        {{if .HasNext}}
        <a href="/audit/progress?page={{.NextPage}}{{if .Query}}&{{.Query}}{{end}}" class="page-btn">ä¸‹ä¸€é¡µ</a>
        {{end}}
        {{if lt .CurrentPage .LastPage}}
        <a href="/audit/progress?page={{.LastPage}}{{if .Query}}&{{.Query}}{{end}}" class="page-btn">æœ€åä¸€é¡µ</a>
        {{end}}
    </div>
    {{end}}
    </div>

    <!-- ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" id="uploadTaskId" name="task_id" value="">
                <div class="upload-form-group">
                    <label>æ¡£æ¡ˆåç§°ï¼š</label>
                    <div id="uploadFileName" style="color: #666; margin-bottom: 10px;"></div>
                </div>
                <div class="upload-form-group">
                    <label for="uploadFileInput">é€‰æ‹©æ–‡ä»¶ï¼š</label>
                    <input type="file" id="uploadFileInput" name="upload_file" required>
                </div>
                <div class="upload-form-actions">
                    <button type="button" class="upload-btn upload-btn-cancel" onclick="closeUploadModal()">å–æ¶ˆ</button>
                    <button type="submit" class="upload-btn">ä¸Šä¼ </button>
                </div>
            </form>
        </div>
    </div>

    </div>

    <script>
    // æ‰“å¼€ä¸Šä¼ æ¨¡æ€æ¡†
    function openUploadModal(taskId, fileName) {
        document.getElementById('uploadTaskId').value = taskId;
        document.getElementById('uploadFileName').textContent = fileName;
        document.getElementById('uploadModal').style.display = 'block';
        document.getElementById('uploadFileInput').value = '';
    }

    // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
    function closeUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
        document.getElementById('uploadForm').reset();
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        var modal = document.getElementById('uploadModal');
        if (event.target == modal) {
            closeUploadModal();
        }
    }

    // å¤„ç†ä¸Šä¼ è¡¨å•æäº¤
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var uploadBtn = this.querySelector('button[type="submit"]');
        var originalText = uploadBtn.textContent;
        
        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºä¸Šä¼ ä¸­
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
        
        fetch('/audit/progress/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                // å°è¯•è§£æJSONé”™è¯¯å“åº”
                return response.json().then(data => {
                    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
                }).catch(() => {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›é€šç”¨é”™è¯¯
                    throw new Error('ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
                closeUploadModal();
                // åˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        });
    });

    // ä¸‹è½½é™„ä»¶
    function downloadAttachment(taskId, fileName) {
        var url = '/audit/progress/download?task_id=' + taskId + '&file_name=' + encodeURIComponent(fileName);
        window.open(url, '_blank');
    }

    // é™„ä»¶æ‚¬åœçª—å£ç®¡ç†
    var attachmentTooltipTimers = {};

    // æ˜¾ç¤ºé™„ä»¶æ‚¬åœçª—å£
    function showAttachmentTooltip(container) {
        // è·å–å®¹å™¨IDæˆ–ä½¿ç”¨å”¯ä¸€æ ‡è¯†
        var containerId = container.getAttribute('data-tooltip-id');
        if (!containerId) {
            containerId = 'tooltip_' + Math.random().toString(36).substr(2, 9);
            container.setAttribute('data-tooltip-id', containerId);
        }
        
        // æ¸…é™¤è¯¥å®¹å™¨çš„éšè—å®šæ—¶å™¨
        if (attachmentTooltipTimers[containerId]) {
            clearTimeout(attachmentTooltipTimers[containerId]);
            delete attachmentTooltipTimers[containerId];
        }
        
        var tooltip = container.querySelector('.attachment-tooltip');
        if (tooltip) {
            tooltip.classList.add('show');
        }
    }

    // éšè—é™„ä»¶æ‚¬åœçª—å£
    function hideAttachmentTooltip(container) {
        var containerId = container.getAttribute('data-tooltip-id');
        if (!containerId) {
            containerId = 'tooltip_' + Math.random().toString(36).substr(2, 9);
            container.setAttribute('data-tooltip-id', containerId);
        }
        
        var tooltip = container.querySelector('.attachment-tooltip');
        if (tooltip) {
            // æ·»åŠ å°å»¶è¿Ÿï¼Œå…è®¸é¼ æ ‡ç§»åŠ¨åˆ°tooltipä¸Š
            attachmentTooltipTimers[containerId] = setTimeout(function() {
                tooltip.classList.remove('show');
                delete attachmentTooltipTimers[containerId];
            }, 150);
        }
    }
    </script>

    </div>
</body>
</html>







